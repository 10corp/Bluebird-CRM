<?php 
function nyss_tags_civicrm_post( $op, $objectName, $objectId, &$objectRef ) {

	//log creator/date when tag is created
	if ( $op == 'create' &&
		 $objectName == 'Tag' ) {
	
		$session = & CRM_Core_Session::singleton();
        $cid = $session->get('userID');
		$tid = $objectRef->id;
		
        $query = "UPDATE civicrm_tag SET created_id = {$cid}, created_date = NOW() WHERE id = {$tid};";
        $dao = CRM_Core_DAO::executeQuery( $query );
	
	}
	
	//Log when a tag is added/removed from a contact
	if ( $objectName == 'EntityTag' ) {
	
		require_once 'CRM/Core/BAO/Log.php';
		require_once 'api/v2/Tag.php';
		
		$session = & CRM_Core_Session::singleton();
        $cid = $session->get('userID');
		
		//CRM_Core_Error::debug($objectId);
		//CRM_Core_Error::debug($objectRef); exit();
		
		if ( is_array( $objectRef ) ) {
			$contacts = array();
			$contacts = $objectRef[0];
			$entity_table = $objectRef[1];
		}
			
		$params = array( 'id' => $objectId );
		$tag =& civicrm_tag_get($params);
		//CRM_Core_Error::debug('t', $tag); exit();
	
		if ( $op == 'create' ) {
		
			foreach ( $contacts as $contact ) {
				$logMessage = 'Added tag: '.stripslashes($tag['name']).' ('.$objectId.')';
        		$logParams = array( 'entity_table'  => $entity_table,
            	               		'entity_id'     => $contact,
            	               		'modified_id'   => $cid,
            	               		'modified_date' => date('YmdHis'),
            	               		'data'          => $logMessage
            	               		);
        		CRM_Core_BAO_Log::add( $logParams );
			}
		
		} elseif ( $op == 'delete' ) {
			
			foreach ( $contacts as $contact ) {
				$logMessage = 'Removed tag: '.stripslashes($tag['name']).' ('.$objectId.')';
        		$logParams = array( 'entity_table'  => $entity_table,
            	               		'entity_id'     => $contact,
            	               		'modified_id'   => $cid,
            	               		'modified_date' => date('YmdHis'),
            	               		'data'          => $logMessage
            	               		);
        		CRM_Core_BAO_Log::add( $logParams );
			}
		
		}
	}

}
