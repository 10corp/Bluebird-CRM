<?php

function dedupe_reset($o, $table, &$tableQueries) {
    // All of our dedupe methods essentially wipe the ruleset clean and insert our own
    // more expressive set of rule logic and thresholds.
    $o->threshold = 5;
    foreach(array_keys($tableQueries) as $key)
        unset($tableQueries[$key]);
}

function nyss_dedupe_civicrm_dupeQuery ($o, $table, &$tableQueries){

    //don't run these during user account/contact creation
    if( $o->noRules || $table != 'table')
        return;

    if ($o->name=='Level 1 (fname + mname + lname + suffix + street + postal)') {
        dedupe_reset($o, $table, $tableQueries);
        
        // The primary strict dedupe rule can be used with different behavior in two different scenarios
        //
        // 1) No parameters are passed in. Contruct query to dedupe internally against other contacts
        if (empty($o->params)) {
            nyss_dedupe_strict_default_internal($o, $table, $tableQueries);
        // 2) We have parameters. Construct a dedupe query with the given parameters that
        //    produces no false positives. False negatives can be dealth with during manual dedupe.
        } else {
            nyss_dedupe_strict_default_record($o, $table, $tableQueries);
        }

    } elseif($o->name=='Level 2 (fname + lname + city + birth)') {

        if (empty($o->params)) {
		    dedupe_reset($o, $table, $tableQueries);
            nyss_dedupe_indiv_level2_internal($o, $table, $tableQueries);
        }

    } elseif($o->name=='Level 3 (street + lname + fname + city + suffix)') {
        
        // The primary fuzzy rule gets called internally when X, Y, and Z happen.
        // CiviCRM handles the record dedupe well enough, only override the internal dedupe for now...
        if (empty($o->params)) {
		    dedupe_reset($o, $table, $tableQueries);
            nyss_dedupe_fuzzy_default_internal($o, $table, $tableQueries);
        }

    } elseif($o->name=='NYSS - Strict Email') {
        dedupe_reset($o, $table, $tableQueries);
        
        // The fuzzy address rule matches contacts where the address is the only difference.
        if (empty($o->params)) {
            // This rule is currently meaningless in the internal context
        } else {
            nyss_dedupe_strict_email_record($o, $table, $tableQueries);
        }
    }

}

function nyss_dedupe_strict_email_record($o, $table, &$tableQueries) {
    require_once 'CRM/Core/DAO.php';

    $civicrm_contact = CRM_Utils_Array::value('civicrm_contact',$o->params);
    $civicrm_email = CRM_Utils_Array::value('civicrm_email',$o->params);
    $civicrm_address = CRM_Utils_Array::value('civicrm_address',$o->params);

    //We can't dedupe anything without a first and last name
    if( empty($civicrm_contact['first_name']) || empty($civicrm_contact['last_name']) )
        return;

    // Since definitely have first and last name, escape them upfront.
    $first_name = CRM_Core_DAO::escapeString($civicrm_contact['first_name']);
    $last_name = CRM_Core_DAO::escapeString($civicrm_contact['last_name']);

    // If we have an email, match on fname + lname + email
    if ($email = CRM_Core_DAO::escapeString(CRM_Utils_Array::value('email',$civicrm_email,''))) {
        $tableQueries['civicrm_contact.email.5'] = "
            SELECT contact.id id1, 5 weight
            FROM civicrm_contact as contact
              JOIN civicrm_email as email on email.contact_id = contact.id
            WHERE contact.contact_type = 'Individual'
              AND contact.first_name = '{$first_name}'
              AND contact.last_name = '{$last_name}'
              AND email.email = '{$email}'
        ";

    // If we have an address, match on fname + lname + street_address
    } elseif ($street_address = CRM_Core_DAO::escapeString(CRM_Utils_Array::value('street_address',$civicrm_address,''))) {
        $tableQueries['civicrm_contact.email.5'] = "
            SELECT contact.id id1, 5 weight
            FROM civicrm_contact as contact
              JOIN civicrm_address as address on address.contact_id = contact.id
            WHERE contact.contact_type = 'Individual'
              AND contact.first_name = '{$first_name}'
              AND contact.last_name = '{$last_name}'
              AND address.street_address = '{$street_address}'
        ";

    // If we have no address or email, then we can't do a match
    } else {}
}

function nyss_dedupe_strict_default_internal($o, $table, &$tableQueries) {
    $tableQueries['civicrm_contact.last_name.5'] = "
        SELECT t1.id id1, t2.id id2, 5 weight
        FROM civicrm_contact t1
          JOIN civicrm_contact t2 ON ( t1.first_name = t2.first_name AND
                                       t1.last_name = t2.last_name AND
                                       IFNULL(t1.middle_name,0) = IFNULL(t2.middle_name,0) AND
                                       IFNULL(t1.suffix_id,0) = IFNULL(t2.suffix_id,0) )
          INNER JOIN civicrm_address a1 on t1.id=a1.contact_id
          INNER JOIN civicrm_address a2 on t2.id=a2.contact_id AND
                     a1.postal_code = a2.postal_code AND
                 a1.street_address = a2.street_address
        WHERE t1.contact_type = 'Individual'
          AND t2.contact_type = 'Individual'
          AND t1.id < t2.id
          AND t1.last_name IS NOT NULL
          AND t1.first_name IS NOT NULL
          AND a1.postal_code IS NOT NULL
          AND a1.street_address IS NOT NULL
    ";
}

function nyss_dedupe_indiv_level2_internal($o, $table, &$tableQueries) {
    //now set custom query; make sure weight matches what is configured in system
    $tableQueries['civicrm_contact.last_name.5'] = "
        SELECT t1.id id1, t2.id id2, 5 weight
        FROM civicrm_contact t1
          JOIN civicrm_contact t2 ON ( t1.first_name = t2.first_name AND
                                       t1.last_name = t2.last_name AND
                                       t1.birth_date = t2.birth_date )
          INNER JOIN civicrm_address a1 on t1.id=a1.contact_id
          INNER JOIN civicrm_address a2 on t2.id=a2.contact_id AND a1.city=a2.city
        WHERE t1.contact_type = 'Individual'
          AND t2.contact_type = 'Individual'
          AND t1.id < t2.id
          AND t1.last_name IS NOT NULL
          AND t1.first_name IS NOT NULL
          AND t1.birth_date IS NOT NULL
          AND t1.birth_date != ''
          AND a1.city IS NOT NULL";
}

function nyss_dedupe_fuzzy_default_internal($o, $table, &$tableQueries) {
    //now set custom query; make sure weight matches what is configured in system
    $tableQueries['civicrm_contact.last_name.5'] = "
        SELECT t1.id id1, t2.id id2, 5 weight
        FROM civicrm_contact t1
          JOIN civicrm_contact t2 ON ( t1.first_name = t2.first_name AND
                                       t1.last_name = t2.last_name AND
                                       IFNULL(t1.middle_name,0) = IFNULL(t2.middle_name,0) AND
                                       IFNULL(t1.suffix_id,0) = IFNULL(t2.suffix_id,0) )
          INNER JOIN civicrm_address a1 on t1.id=a1.contact_id
          INNER JOIN civicrm_address a2 on t2.id=a2.contact_id AND a1.street_address=a2.street_address AND a1.city=a2.city
        WHERE t1.contact_type = 'Individual'
          AND t2.contact_type = 'Individual'
          AND t1.id < t2.id
          AND t1.last_name IS NOT NULL
          AND t1.first_name IS NOT NULL
          AND a1.street_address IS NOT NULL
          AND a1.city IS NOT NULL";
}

function nyss_dedupe_strict_default_record($o, $table, &$tableQueries) {
    // construct abbreviation and punctuation replacements list for street_address
    // the idea here is to replicate the behavior of the USPS API as closely as possible.
    $abbrevs = array( ','           => ' ',
                      '.'           => ' ',
                      '-'           => ' ',
                      ':'           => ' ',
                      ';'           => ' ',
                      '#'           => ' ',
                      ' street '    => ' st ',
                      ' road '      => ' rd ',
                      ' boulevard ' => ' blvd ',
                      ' avenue '    => ' ave ',
                      ' terrace '   => ' ter ',
                      ' parkway '   => ' pkwy ',
                      ' west '      => ' w ',
                      ' east '      => ' e ',
                      ' north '     => ' n ',
                      ' south '     => ' s ',
                      ' apartment ' => ' ',
                      ' apt '       => ' ',
                      ' place '     => ' pl ',
                      ' penthouse ' => ' ph ',
                      ' '         => '',
                    );

    //Build some dynamic SQL!
    $where = "WHERE t1.contact_type = 'Individual'\n";

    //Add contact field filters
    $contact = $o->params['civicrm_contact'];
    foreach(array('last_name','first_name','middle_name','suffix_id') as $key) {
        if( array_key_exists($key, $contact) && $value=$contact[$key])
            $expression = " = '".trim($value)."'";
        else
            $expression = "IS NULL";
        $where .= " AND t1.$key $expression\n";
    }

    //Add address field filters
    $address =& $o->params['civicrm_address'];

    if( array_key_exists('postal_code',$address) && $value=$address['postal_code'])
        $where .= " AND a1.postal_code = '$value'\n";
    else
        $where .= " AND a1.postal_code IS NULL\n";

    if( array_key_exists('street_address',$address) && $value=$address['street_address']) {
        //Build the php representation
        $regexp = "/(?<=[0-9])(?:st|nd|rd|th)/";
        $street_address_php = trim(strtolower($value));
        $street_address_php = preg_replace($regexp, '', ' '.$street_address_php.' '); #Eliminate a bunch of edge cases around replacement
        $street_address_php = str_replace(array_keys($abbrevs),array_values($abbrevs),$street_address_php);

        //Build the sql representation
        $street_address_sql = "preg_replace('$regexp','',CONCAT(' ',TRIM(LCASE(a1.street_address)),' '))";
        foreach ( $abbrevs as $longname => $abbrev )
            $street_address_sql = "REPLACE( $street_address_sql, '$longname', '$abbrev' )";

        $where .= " AND $street_address_sql = '$street_address_php'";
    } else
        $where .= " AND a1.street_address IS NULL";


    $tableQueries['civicrm_contact.last_name.5'] = "
        SELECT t1.id id1, 10 weight
        FROM civicrm_contact t1
          INNER JOIN civicrm_address a1 on t1.id=a1.contact_id
        $where
    ";
}