<?php 

function nyss_dedupe_civicrm_dupeQuery ($o, $table, &$tableQueries){
//CRM_Core_Error::debug($o);exit();
//CRM_Core_Error::debug($tableQueries);exit();

	//don't run these during user account/contact creation
	if ( !$o->noRules ) {
	
		//indiv default strict
		if ( $table == 'table' && $o->name=='Level 1 (fname + lname + birth + postal)' ) {

			$tableQueries['civicrm_contact.last_name.1'] = "
SELECT t1.id id1, t2.id id2, 1 weight 
FROM civicrm_contact t1 
  JOIN civicrm_contact t2 USING (first_name, last_name, birth_date) 
  INNER JOIN civicrm_address a1 on t1.id=a1.id 
  INNER JOIN civicrm_address a2 on t2.id=a2.id AND a1.postal_code=a2.postal_code 
WHERE t1.contact_type = 'Individual' 
  AND t2.contact_type = 'Individual' 
  AND t1.id <> t2.id 
  AND t1.birth_date IS NOT NULL 
  AND t1.last_name IS NOT NULL 
  AND t1.first_name IS NOT NULL 
  AND a1.postal_code IS NOT NULL"; 

		}
	
	}

//CRM_Core_Error::debug($o);exit();	
}
