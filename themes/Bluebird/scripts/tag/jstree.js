// Generated by CoffeeScript 1.6.3
var Instance, getTrees, jstree, setProp, _utils,
  __slice = [].slice,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
  _this = this;

Function.prototype.property = function(prop, desc) {
  return Object.defineProperty(this.prototype, prop, desc);
};

jstree = {
  init: function(settings, view) {
    var instance, pageElements, request,
      _this = this;
    instance = new Instance();
    setProp(settings, instance);
    pageElements = instance.get("pageElements");
    view["exec"].call(this, instance);
    cj(pageElements.wrapper).data("isLoading", true);
    request = cj.when(getTrees.getRawJSON(instance));
    request.done(function(data) {
      getTrees.putRawJSON(data.message, instance);
      cj(pageElements.wrapper).data("isLoading", false);
      return view["done"].call(_this, instance);
    });
    return instance;
  }
};

setProp = function() {
  var instance, k, properties, v, _i, _ref, _results;
  properties = 2 <= arguments.length ? __slice.call(arguments, 0, _i = arguments.length - 1) : (_i = 0, []), instance = arguments[_i++];
  _ref = properties[0];
  _results = [];
  for (k in _ref) {
    v = _ref[k];
    _results.push(instance.set(k, v));
  }
  return _results;
};

getTrees = {
  getRawJSON: function(instance) {
    return cj.ajax(instance.get('callAjax'));
  },
  putRawJSON: function(data, instance) {
    var rawData;
    rawData = {};
    cj.each(data, function(i, tID) {
      var _ref;
      if (_ref = parseFloat(tID.id), __indexOf.call(instance.get('dataSettings').pullSets, _ref) >= 0) {
        return rawData[tID.id] = {
          'name': tID.name,
          'children': tID.children
        };
      }
    });
    return instance.rawData = rawData;
  }
};

Instance = (function() {
  function Instance(_rawData, _autocomplete, _treeNames, _trees) {
    var callAjax, dataSettings, displaySettings, onSave, pageElements,
      _this = this;
    this._rawData = _rawData;
    this._autocomplete = _autocomplete;
    this._treeNames = _treeNames;
    this._trees = _trees;
    pageElements = {
      init: 'JSTreeInit',
      wrapper: 'JSTreeContainer',
      tagHolder: ['JSTree'],
      messageHandler: ['JSMessages'],
      location: ''
    };
    onSave = false;
    dataSettings = {
      pullSets: [291, 296, 292],
      entity_id: 0
    };
    displaySettings = {
      defaultTree: 291,
      mode: 'edit',
      size: 'full',
      autocomplete: true,
      print: true,
      showActive: true,
      showStubs: false
    };
    callAjax = {
      url: 'localtagdata.json',
      dataType: 'json'
    };
    this.get = function(name) {
      var getRet;
      getRet = {};
      if ('pageElements' === name) {
        cj.extend(true, getRet, pageElements);
      }
      if ('onSave' === name) {
        return onSave;
      }
      if ('dataSettings' === name) {
        cj.extend(true, getRet, dataSettings);
      }
      if ('displaySettings' === name) {
        cj.extend(true, getRet, displaySettings);
      }
      if ('callAjax' === name) {
        cj.extend(true, getRet, callAjax);
      }
      if ('ready' === name) {
        return ready;
      }
      return getRet;
    };
    this.set = function(name, obj) {
      var ready;
      if ('pageElements' === name) {
        obj = _utils.checkForArray(pageElements, obj);
        cj.extend(true, pageElements, obj);
      }
      if ('onSave' === name) {
        onSave = obj;
      }
      if ('dataSettings' === name) {
        obj = _utils.checkForArray(dataSettings, obj);
        cj.extend(true, dataSettings, obj);
      }
      if ('displaySettings' === name) {
        obj = _utils.checkForArray(displaySettings, obj);
        cj.extend(true, displaySettings, obj);
      }
      if ('callAjax' === name) {
        obj = _utils.checkForArray(callAjax, obj);
        cj.extend(true, callAjax, obj);
      }
      if ('ready' === name) {
        return ready = obj;
      }
    };
  }

  Instance.property("rawData", {
    get: function() {
      return this._rawData;
    },
    set: function(a) {
      return this._rawData = a;
    }
  });

  Instance.property("autocomplete", {
    get: function() {
      return this._autocomplete;
    },
    set: function(a) {
      return this._autocomplete = a;
    }
  });

  Instance.property("treeNames", {
    get: function() {
      return this._treeNames;
    },
    set: function(a) {
      return this._treeNames = a;
    }
  });

  Instance.property("trees", {
    get: function() {
      return this._trees;
    },
    set: function(a) {
      return this._trees = a;
    }
  });

  return Instance;

})();

_utils = {
  removeDupFromExtend: function(obj) {
    return cj.each(obj, function(k, v) {
      if (cj.isPlainObject(v)) {
        _this.removeDupFromExtend(v);
      }
      return v = bbUtils.uniqueAry(v);
    });
  },
  checkForArray: function(propDefault, obj) {
    return cj.each(obj, function(k, def) {
      var a, ar, b, c, i, _i, _j, _len, _len1;
      if (cj.isArray(def) && cj.isArray(propDefault[k])) {
        a = propDefault[k].sort();
        b = def.sort();
        for (i = _i = 0, _len = a.length; _i < _len; i = ++_i) {
          c = a[i];
          if (c !== b[i]) {
            for (_j = 0, _len1 = def.length; _j < _len1; _j++) {
              ar = def[_j];
              if (propDefault[k].indexOf(ar) < 0) {
                propDefault[k].push(ar);
              }
            }
          }
        }
        return obj[k] = propDefault[k];
      }
    });
  },
  textWrap: function(text, length) {
    var a, numberOfSegs, rx, seg, shouldRet, toRet, _i;
    numberOfSegs = Math.ceil(text.length / length);
    toRet = "";
    shouldRet = false;
    rx = /\s|-| |\u00A0|\u8209|\r|\n/g;
    for (a = _i = 0; 0 <= numberOfSegs ? _i <= numberOfSegs : _i >= numberOfSegs; a = 0 <= numberOfSegs ? ++_i : --_i) {
      seg = text.slice(length * a, length * (a + 1));
      if (!seg.match(rx) && seg.length >= length) {
        shouldRet = true;
        toRet += "" + seg + " ";
      } else {
        toRet += "" + seg;
      }
    }
    if (shouldRet) {
      return toRet;
    }
    return text;
  }
};

window.jstree = jstree;
