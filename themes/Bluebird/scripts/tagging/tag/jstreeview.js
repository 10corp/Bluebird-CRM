// Generated by CoffeeScript 1.6.3
var Action, ActivityLog, Autocomplete, Buttons, Label, Node, Resize, Settings, Token, Tree, View, _descWidths, _manipTags, _openTags, _treeUtils, _treeVisibility;

window.jstree["views"] = {
  exec: function(instance) {
    this.view = new View(instance);
    return this.menuSettings = new Settings(instance, this.view);
  },
  done: function(instance) {
    var a, b, displaySettings, resize, trees, v, _ref;
    trees = {};
    displaySettings = instance.get('displaySettings');
    _ref = instance.treeNames;
    for (a in _ref) {
      v = _ref[a];
      if (a !== "292") {
        b = _treeUtils.selectByTree(instance.autocomplete, a);
        trees[a] = new Tree(b, a);
      } else {
        b = instance.positionList;
        if (displaySettings.edit) {
          trees[a] = new Tree(b, a);
        } else {
          trees[a] = new Tree(b, a, false, "init");
        }
      }
    }
    this.view.trees = trees;
    this.view.init();
    if (this.view.settings.tall && !this.view.settings.lock) {
      resize = new Resize;
      return resize.addResize(instance, this.view);
    } else {
      return this.view.cj_tokenHolder.resize.remove();
    }
  },
  changeEntity: function(entity_id) {
    this.view = jstree.view;
    this.view.entity_id = entity_id;
    return this.view.applyTagged();
  }
};

View = (function() {
  View.property("trees", {
    get: function() {
      return this._trees;
    },
    set: function(a) {
      return this._trees = a;
    }
  });

  View.prototype.selectors = {
    tagBox: "",
    container: "",
    containerClass: "",
    initHolder: "",
    byHeightWidth: "",
    dropdown: "",
    defaultTree: "",
    activeTree: "",
    isFiltered: false,
    data: "data",
    idedKeys: ["container", "data"],
    addPrefix: ["dropdown", "data"]
  };

  View.prototype.menuSelectors = {
    menu: "menu",
    top: "top",
    tabs: "tabs",
    bottom: "bottom",
    autocomplete: "autocomplete",
    settings: "settings",
    addPrefix: ["menu", "tabs", "top", "bottom", "autocomplete", "settings"]
  };

  View.prototype.tokenHolder = {
    box: "tokenHolder",
    options: "options",
    body: "tokenBody",
    resize: "resize",
    left: "left",
    addPrefix: ["box", "options", "body", "resize", "left"]
  };

  View.prototype.settings = {
    tall: true,
    wide: true,
    edit: false,
    tagging: false,
    print: true,
    lock: false,
    dropdown: false
  };

  View.prototype.entity_id = 0;

  View.prototype.entityList = [];

  View.prototype.defaultPrefix = "JSTree";

  View.prototype.prefixes = [];

  View.prototype.defaultTree = 0;

  View.prototype.descWidths = {
    normal: 75,
    long: 150
  };

  function View(instance) {
    this.instance = instance;
    this.writeContainers();
  }

  View.prototype.applyTagged = function() {
    var _this = this;
    return this.instance.getEntity(this.entity_id, function(tags) {
      var autoHeight, curHeight, id, _i, _len, _ref;
      if (_this.entityList.length > 0) {
        _this.removeAllTagsFromEntity();
        _this.cj_tokenHolder.body.empty();
      }
      _this.entityList = tags;
      if (_this.entityList.length > 0) {
        _this.applyTaggedKWIC();
        _this.applyTaggedPositions();
        _ref = _this.entityList;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          id = _ref[_i];
          _this.addTagsToHolder(id);
        }
        _this.cj_tokenHolder.options.find(".showToggle").off("click");
        _this.cj_tokenHolder.options.find(".showToggle").on("click", function() {
          return _this.slideTokenHolder();
        });
        if (_this.cj_tokenHolder.box.hasClass("closed")) {
          curHeight = _this.cj_tokenHolder.box.height();
          _this.cj_tokenHolder.box.css('height', 'auto');
          autoHeight = _this.cj_tokenHolder.box.height();
          _this.cj_tokenHolder.box.height(curHeight);
          return _this.cj_tokenHolder.box.animate({
            height: autoHeight
          }, 100, function() {
            _this.cj_tokenHolder.box.css('height', 'auto');
            _this.cj_tokenHolder.box.removeClass("closed");
            if (_this.settings.dropdown) {
              return _this.slideTokenHolder();
            }
          });
        }
      }
    });
  };

  View.prototype.slideTokenHolder = function() {
    var autoHeight, curHeight,
      _this = this;
    if (this.cj_tokenHolder.body.height() <= 20) {
      this.cj_tokenHolder.options.find(".showToggle").toggleClass("slideUp");
      curHeight = this.cj_tokenHolder.body.height();
      this.cj_tokenHolder.body.css('height', 'auto');
      autoHeight = this.cj_tokenHolder.body.height();
      this.cj_tokenHolder.body.height(curHeight);
      return this.cj_tokenHolder.body.animate({
        height: autoHeight
      }, 500, function() {});
    } else {
      this.cj_tokenHolder.options.find(".showToggle").toggleClass("slideUp");
      return this.cj_tokenHolder.body.animate({
        height: "16px"
      }, 500, function() {});
    }
  };

  View.prototype.addTagsToHolder = function(id) {
    var cjDT, killToken, name, token, type,
      _this = this;
    cjDT = this.cj_selectors.tagBox.find("#tagLabel_" + id);
    killToken = function() {
      return cjDT.find("input.checkbox").prop("checked", false).trigger("change");
    };
    name = cjDT.data("name");
    type = cjDT.data("tree");
    token = new Token(this.cj_tokenHolder.body);
    return token.create(this.cj_tokenHolder.body, name, type, id, killToken);
  };

  View.prototype.removeAllTagsFromEntity = function() {
    var cjDTs;
    cjDTs = this.cj_selectors.tagBox.find("dt");
    cjDTs.find("dt").removeClass("shaded").removeClass("shadedChildren");
    return cjDTs.find("dt input.checkbox").prop("checked", false);
  };

  View.prototype.applyTaggedKWIC = function(filter) {
    var cjDTs, findList, i, _i, _len, _ref,
      _this = this;
    if (filter == null) {
      filter = "";
    }
    findList = [];
    _ref = this.entityList;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      i = _ref[_i];
      findList.push("" + filter + " #tagLabel_" + i);
    }
    cjDTs = this.cj_selectors.tagBox.find(findList.join(","));
    cjDTs.addClass("shaded");
    return cj.each(cjDTs, function(i, DT) {
      cj(DT).find(".fCB input.checkbox").prop("checked", true);
      return _this.hasTaggedChildren(cj(DT));
    });
  };

  View.prototype.findPositionLocalMatch = function(cjDT) {
    var a, b, name, position, _ref, _results;
    name = cjDT.find(".tag .name").text;
    _ref = this.instance.positionList;
    _results = [];
    for (a in _ref) {
      b = _ref[a];
      name = _utils.removePositionTextFromBill(cjDT.name);
      _results.push(position = cjDT.data("position"));
    }
    return _results;
  };

  View.prototype.applyTaggedPositions = function() {
    var a, b, cjDTs, iO, posList, trees, _ref;
    posList = [];
    trees = this.trees;
    _ref = this.instance.positionList;
    for (a in _ref) {
      b = _ref[a];
      iO = this.entityList.indexOf("" + b.id);
      if (iO > -1) {
        posList.push(b);
      }
    }
    if (posList.length > 0) {
      this.cj_selectors.tagBox.find(".top-292").remove();
      trees[292] = new Tree(posList, 292);
      if (this.cj_menuSelectors.tabs.find(".tab-positions").hasClass("active")) {

      } else {
        this.cj_selectors.tagBox.find(".top-292").css("display", "none");
      }
      new Buttons(this, ".top-292");
      cjDTs = this.cj_selectors.tagBox.find(".top-292 dt");
      cjDTs.addClass("shaded");
      cjDTs.find(".fCB input.checkbox").prop("checked", true);
      return this.trees = trees;
    } else {
      return this.addPositionReminderText(this.cj_selectors.tagBox.find(".top-292"));
    }
  };

  View.prototype.writeContainers = function() {
    var height, tagBox;
    this.formatPageElements();
    this.createSelectors();
    tagBox = new Resize;
    if (tagBox != null) {
      if (tagBox.height === 0) {
        this.setDescWidths(false, void 0);
      } else {
        this.setDescWidths();
      }
    }
    if (this.settings.tall) {
      if (tagBox != null) {
        if (tagBox.height > 0) {
          height = " style='height:" + tagBox.height + "px'";
          return this.addClassesToElement(height);
        } else {
          return this.buildDropdown();
        }
      } else {
        height = "";
        return this.addClassesToElement(height);
      }
    } else {
      return this.buildDropdown();
    }
  };

  View.prototype.setDescWidths = function(tall, wide) {
    if (tall == null) {
      tall = this.settings.tall;
    }
    if (wide == null) {
      wide = this.settings.wide;
    }
    if (tall) {
      if (wide) {
        _descWidths.normal = 75;
        return _descWidths.long = 150;
      } else {
        _descWidths.normal = 38;
        return _descWidths.long = 38;
      }
    } else {
      if (wide) {
        _descWidths.normal = 70;
        return _descWidths.long = 140;
      } else {
        _descWidths.normal = 38;
        return _descWidths.long = 38;
      }
    }
  };

  View.prototype.buildDropdown = function() {
    this.cj_selectors.initHolder.html("<div class='" + this.selectors.tagBox + " dropdown'></div><div class='JSTree-overlay'></div>");
    this.cj_selectors.initHolder.prepend(this.menuHtml(this.menuSelectors));
    this.cj_selectors.initHolder.append(this.dataHolderHtml());
    this.cj_selectors.initHolder.append(this.tokenHolderHtml(this.tokenHolder));
    return this.cj_selectors.initHolder.removeClass(this.selectors.initHolder).attr("id", this.selectors.container).addClass(this.selectors.containerClass);
  };

  View.prototype.addClassesToElement = function(height) {
    this.cj_selectors.initHolder.html("<div class='" + this.selectors.tagBox + "' " + height + "></div><div class='JSTree-overlay'></div>");
    this.cj_selectors.initHolder.prepend(this.menuHtml(this.menuSelectors));
    this.cj_selectors.initHolder.append(this.dataHolderHtml());
    this.cj_selectors.initHolder.append(this.tokenHolderHtml(this.tokenHolder));
    return this.cj_selectors.initHolder.removeClass(this.selectors.initHolder).attr("id", this.selectors.container).addClass(this.selectors.containerClass);
  };

  View.prototype.formatPageElements = function() {
    var dataSettings, displaySettings, pageElements, v, _i, _len, _ref;
    pageElements = this.instance.get('pageElements');
    displaySettings = this.instance.get('displaySettings');
    dataSettings = this.instance.get('dataSettings');
    this.selectors.container = pageElements.wrapper.shift();
    this.selectors.containerClass = pageElements.wrapper.join(" ");
    this.selectors.tagBox = pageElements.tagHolder.join(" ");
    this.menuSelectors.tabs = pageElements.tabLocation;
    this.menuSelectors.autocomplete = pageElements.autocomplete;
    this.selectors.dropdown = pageElements.tagDropdown;
    this.selectors.initHolder = pageElements.init;
    this.entity_id = dataSettings.entity_id;
    this.settings = displaySettings;
    this.settingCollection = ["settings", "menuSelectors", "tokenHolder", "selectors"];
    _ref = pageElements.tagHolder;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      v = _ref[_i];
      this.prefixes.push(v);
    }
    this.joinPrefix();
    this.selectors.byHeightWidth = this.setByHeightWidth();
    if (!this.settings.wide) {
      return this.selectors.containerClass += " narrow";
    }
  };

  View.prototype.joinPrefix = function() {
    var a, i, k, name, o, v, _i, _len, _ref, _results;
    _ref = this.settingCollection;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      v = _ref[_i];
      _results.push((function() {
        var _j, _len1, _ref1, _ref2, _results1;
        _ref1 = this["" + v];
        _results1 = [];
        for (k in _ref1) {
          o = _ref1[k];
          if (typeof o !== "string" || o.length === 0) {
            continue;
          }
          if (this["" + v].idedKeys != null) {
            if (this["" + v].idedKeys.indexOf(k) >= 0) {
              if (this["" + v].addPrefix != null) {
                if (this["" + v].addPrefix.indexOf(k) >= 0) {
                  this["" + v][k] = "" + this.prefixes[0] + "-" + o;
                  this["" + v].addPrefix.splice(this["" + v].addPrefix.indexOf(k), 1);
                }
              }
            }
          }
          if (this["" + v].addPrefix != null) {
            if (this["" + v].addPrefix.indexOf(k) >= 0) {
              name = "";
              _ref2 = this.prefixes;
              for (i = _j = 0, _len1 = _ref2.length; _j < _len1; i = ++_j) {
                a = _ref2[i];
                name += "" + a + "-" + o;
                if (this.prefixes.length - 1 > i) {
                  name += " ";
                }
              }
              _results1.push(this["" + v][k] = name);
            } else {
              _results1.push(void 0);
            }
          } else {
            _results1.push(void 0);
          }
        }
        return _results1;
      }).call(this));
    }
    return _results;
  };

  View.prototype.createSelectors = function() {
    var v, _i, _len, _ref, _results;
    _ref = this.settingCollection;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      v = _ref[_i];
      _results.push(this.createCJfromObj(this[v], v));
    }
    return _results;
  };

  View.prototype.createCJfromObj = function(obj, name) {
    var cjed, k, selectorType, v;
    cjed = {};
    for (k in obj) {
      v = obj[k];
      if (typeof v !== "string" || v.length === 0) {
        continue;
      }
      selectorType = ".";
      if (obj.idedKeys != null) {
        if (obj["idedKeys"].indexOf(k) >= 0) {
          selectorType = "#";
        }
      }
      cjed[k] = cj("" + selectorType + (cj.trim(v).replace(/\ /g, ".")));
    }
    return this["cj_" + name] = cjed;
  };

  View.prototype.setByHeightWidth = function() {
    var ret;
    ret = "";
    if (!this.settings.wide) {
      ret += "narrow ";
    }
    if (!this.settings.tall) {
      ret += "short";
    }
    return ret;
  };

  View.prototype.menuHtml = function(name) {
    return "      <div class='" + name.menu + "'>       <div class='" + name.top + "'>        <div class='" + name.tabs + "'></div>        <div class='" + name.settings + "'></div>       </div>       <div class='" + name.bottom + "'>        <div class='" + name.autocomplete + "'>         <input type='text' id='JSTree-ac'>        </div>        <div class='" + name.settings + "'></div>       </div>      </div>    ";
  };

  View.prototype.tokenHolderHtml = function(name) {
    var html;
    return html = "        <div class='" + name.box + " closed'>         <div class='" + name.options + "' >          <div class='showToggle' title='Toggle Tokens'></div>         </div>         <div class='" + name.body + "'></div>        </div>        <div class='" + name.resize + "'></div>      ";
  };

  View.prototype.dataHolderHtml = function() {
    return "<div id='JSTree-data' style='display:none'></div>";
  };

  View.prototype.init = function() {
    var ac, buttons, k, tabName, v, _ref;
    this.createSelectors();
    _treeVisibility.currentTree = _treeVisibility.defaultTree = _treeVisibility.previousTree = this.settings.defaultTree;
    _ref = this.instance.treeNames;
    for (k in _ref) {
      v = _ref[k];
      tabName = this.createTreeTabs(v);
    }
    this.setActiveTree(this.settings.defaultTree);
    ac = new Autocomplete(this.instance, this);
    this.createTabClick();
    buttons = new Buttons(this);
    return this.setTaggingOrEdit();
  };

  View.prototype.setTaggingOrEdit = function() {
    if (this.cj_selectors.tagBox.hasClass("tagging,edit")) {
      this.cj_selectors.tagBox.removeClass("tagging").removeClass("edit");
    }
    if (this.settings.edit && this.settings.tagging) {
      this.settings.tagging = false;
    }
    if (this.settings.edit) {
      this.initPositionList(this.cj_selectors.tagBox.find(".top-292"));
      this.cj_selectors.tagBox.addClass("edit");
    }
    if (this.settings.tagging) {
      this.cj_selectors.tagBox.addClass("tagging");
      return this.applyTagged();
    }
  };

  View.prototype.initPositionList = function(cjlocation) {
    var positionText;
    positionText = "              <div class='position-box-text-reminder'>                These positions are in your instance.              </div>          ";
    return cjlocation.prepend(positionText);
  };

  View.prototype.unbindTabClick = function() {
    var k, v, _ref, _results;
    _ref = this.instance.treeNames;
    _results = [];
    for (k in _ref) {
      v = _ref[k];
      _results.push(this.cj_menuSelectors.tabs.find(".tab-" + (this.getTabNameFromId(k, true))).off("click"));
    }
    return _results;
  };

  View.prototype.createTabClick = function() {
    var k, onTabClick, tabName, v, _ref, _results;
    this.unbindTabClick();
    onTabClick = function(currentTree, tabName) {
      var _this = this;
      return this.cj_menuSelectors.tabs.find("." + tabName).on("click", function() {
        return _this.showTags(currentTree, tabName);
      });
    };
    cj.each(this.cj_menuSelectors.tabs.find("div"), function(i, div) {
      return cj(div).off("click");
    });
    _ref = this.instance.treeNames;
    _results = [];
    for (k in _ref) {
      v = _ref[k];
      tabName = "tab-" + (this.getTabNameFromId(k, true));
      onTabClick.call(this, k, "" + tabName);
      if (parseInt(k) === 292 && !this.settings.tagging) {
        _results.push(this.addPositionReminderText(this.cj_selectors.tagBox.find(".top-" + k)));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  View.prototype.showTags = function(currentTree, tabName, noPrev) {
    if (currentTree !== _treeVisibility.currentTree) {
      this.cj_menuSelectors.tabs.find(".tab-" + (this.getTabNameFromId(_treeVisibility.currentTree, true))).removeClass("active");
      this.cj_selectors.tagBox.removeClass("top-" + _treeVisibility.currentTree + "-active");
      this.cj_selectors.tagBox.find(".top-" + _treeVisibility.currentTree).toggle().removeClass("active");
      _treeVisibility.previousTree = _treeVisibility.currentTree;
      _treeVisibility.currentTree = currentTree;
      this.cj_menuSelectors.tabs.find(".tab-" + (this.getTabNameFromId(currentTree, true))).addClass("active");
      this.cj_selectors.tagBox.find(".top-" + currentTree).toggle().addClass("active");
      this.cj_selectors.tagBox.addClass("top-" + currentTree + "-active");
      return this.setOverlay();
    }
  };

  View.prototype.setOverlay = function() {
    var cjOverlay, height;
    if (this.cj_selectors.tagBox.hasClass("dropdown")) {
      cjOverlay = this.cj_selectors.container.find(".JSTree-overlay");
      height = this.cj_selectors.tagBox.height();
      cjOverlay.height(this.cj_selectors.tagBox.height());
      cjOverlay.width(this.cj_selectors.tagBox.width());
      if (this.cj_selectors.tagBox.hasClass("filtered")) {
        if (height === 0) {
          return this.cj_menuSelectors.menu.addClass("noResults");
        } else {
          return this.cj_menuSelectors.menu.removeClass("noResults");
        }
      } else {
        return this.cj_menuSelectors.menu.removeClass("noResults");
      }
    } else {
      cjOverlay = this.cj_selectors.container.find(".JSTree-overlay");
      cjOverlay.css("height", "100%");
      return cjOverlay.css("width", "100%");
    }
  };

  View.prototype.setActiveTree = function(id) {
    var tabName;
    tabName = this.getTabNameFromId(id, true);
    this.cj_menuSelectors.tabs.find("div").removeClass("active");
    this.cj_selectors.tagBox.find(".tagContainer").removeClass("active").css("display", "none");
    this.setOverlay();
    this.cj_menuSelectors.tabs.find(".tab-" + tabName).addClass("active");
    this.cj_selectors.tagBox.find(".top-" + id).addClass("active").css("display", "block");
    return this.cj_selectors.tagBox.addClass("top-" + id + "-active");
  };

  View.prototype.createTreeTabs = function(tabName, isHidden) {
    var output, style, tabClass;
    if (isHidden == null) {
      isHidden = false;
    }
    if (isHidden) {
      style = "style='display:none'";
    } else {
      style = "";
    }
    tabClass = (_utils.hyphenize(tabName)).toLowerCase();
    output = "<div class='tab-" + tabClass + "' " + style + ">" + tabName + "</div>";
    return this.cj_menuSelectors.tabs.append(output);
  };

  View.prototype.getTabNameFromId = function(id, hyphenize) {
    var treeNames;
    if (hyphenize == null) {
      hyphenize = false;
    }
    treeNames = this.instance.treeNames;
    if (!hyphenize) {
      return treeNames[id];
    }
    return _utils.hyphenize(treeNames[id]).toLowerCase();
  };

  View.prototype.getIdFromTabName = function(tabName) {
    tabName = cj.trim(tabName);
    if (tabName === "tab-issue-codes" || tabName === "issue-codes") {
      return 291;
    }
    if (tabName === "tab-keywords" || tabName === "keywords") {
      return 296;
    }
    if (tabName === "tab-positions" || tabName === "positions") {
      return 292;
    }
  };

  View.prototype.buildFilteredList = function(tags) {
    var buildList, checkAgainst, d, e, k, m, n, o, x, y, _ref;
    checkAgainst = {};
    for (m in tags) {
      n = tags[m];
      checkAgainst[m] = [];
      for (x in n) {
        y = n[x];
        checkAgainst[m].push(parseFloat(y.id));
      }
    }
    buildList = {};
    for (d in checkAgainst) {
      e = checkAgainst[d];
      buildList[d] = [];
      _ref = this.instance.autocomplete;
      for (k in _ref) {
        o = _ref[k];
        if (e.indexOf(parseFloat(o.id)) >= 0) {
          buildList[d].push(o);
        }
      }
    }
    return buildList;
  };

  View.prototype.shouldBeFiltered = false;

  View.prototype.currentWrittenTerm = "";

  View.prototype.queryLog = {
    "291": [],
    "296": [],
    "292": []
  };

  View.prototype.createQueryLog = function(term, tree) {
    var k, v, _ref;
    if (this.queryLog[tree].lastIndexOf(term) < 0) {
      this.queryLog[tree].push(term);
    }
    _ref = this.queryLog;
    for (k in _ref) {
      v = _ref[k];
      if (v.length > this.queryLog[tree].length) {
        return false;
      }
    }
    return true;
  };

  View.prototype.writeFilteredList = function(list, term, hits) {
    var activeTree, delay, k, latestQuery, t, v,
      _this = this;
    if (hits == null) {
      hits = {};
    }
    if (!this.shouldBeFiltered) {
      return false;
    }
    for (k in hits) {
      v = hits[k];
      latestQuery = this.createQueryLog(term, "" + k);
      if (!latestQuery) {
        return false;
      }
    }
    if (!this.cj_selectors.tagBox.hasClass("filtered")) {
      this.cj_selectors.tagBox.addClass("filtered");
    }
    cj.each(this.cj_selectors.tagBox.find(".tagContainer"), function(i, tree) {
      var cjTree;
      cjTree = cj(tree);
      if (!cjTree.hasClass("filtered")) {
        cjTree.remove();
      }
      if (cjTree.data("term") !== term) {
        return cjTree.remove();
      }
    });
    for (k in hits) {
      v = hits[k];
      activeTree = this.cj_menuSelectors.tabs.find(".active").attr("class").replace("active", "");
      if (v === 0) {
        this.setTabResults(k, "0");
        this.cj_selectors.tagBox.find(".top-" + k).data("term", term);
      } else {
        this.setTabResults(k, v);
        t = new Tree(list[k], k, true);
        this.cj_selectors.tagBox.find(".top-" + k).data("term", term);
      }
      if (this.settings.tagging) {
        if (parseInt(k) === 292) {
          if (v > 0) {
            delay = function(ms, func) {
              return setTimeout(func, ms);
            };
            delay(100, function() {
              var a, b, cjDTs, iO, _ref, _results;
              _ref = _this.instance.positionList;
              _results = [];
              for (a in _ref) {
                b = _ref[a];
                iO = b.id.indexOf(_this.entityList);
                if (iO > -1) {
                  cjDTs = _this.cj_selectors.tagBox.find("#tagLabel_" + b.id);
                  _results.push(cjDTs.addClass("shaded"));
                } else {
                  _results.push(void 0);
                }
              }
              return _results;
            });
          }
        }
      }
    }
    new Buttons(this);
    if (this.settings.tagging) {
      if (this.entityList != null) {
        this.applyTaggedKWIC();
      } else {
        delay = function(ms, func) {
          return setTimeout(func, ms);
        };
        delay(500, function() {
          return _this.applyTaggedKWIC();
        });
      }
    }
    return this.setActiveTree(this.getIdFromTabName(activeTree));
  };

  View.prototype.noResultsBox = function(treeId, k) {
    var activeTree, isActive, noResults;
    activeTree = this.getIdFromTabName(cj.trim(cj(".JSTree-tabs .active").attr("class").replace(/active/g, "")));
    if (parseInt(k) === parseInt(activeTree)) {
      isActive = "active";
    } else {
      isActive = "";
    }
    noResults = "            <div class='top-" + k + " tagContainer filtered " + isActive + " no-results'>              <div class='no-results'>                No Results Found              </div>            </div>          ";
    return cj(".JSTree").append(noResults);
  };

  View.prototype.rebuildInitialTree = function() {
    var activeTree, k, t, v, _ref;
    if (this.cj_selectors.tagBox.hasClass("filtered")) {
      this.cj_selectors.tagBox.removeClass("filtered");
      this.cj_selectors.tagBox.find(".filtered").remove();
      activeTree = this.cj_menuSelectors.tabs.find(".active").attr("class").replace("active", "");
      _ref = this.trees;
      for (k in _ref) {
        v = _ref[k];
        if (parseInt(k) !== 292) {
          t = new Tree(v.tagList, k);
        }
        if (parseInt(k) === 292 && !this.settings.tagging) {
          t = new Tree(v.tagList, k);
          this.initPositionList(this.cj_selectors.tagBox.find(".top-" + k));
        }
        if (parseInt(k) === 292 && this.settings.tagging) {
          t = new Tree(v.tagList, k, false, "init");
          this.cj_selectors.tagBox.find(".top-" + k).empty();
          if (this.entityList.length === 0) {
            this.addPositionReminderText(this.cj_selectors.tagBox.find(".top-" + k));
          } else {
            this.applyTaggedPositions();
          }
        }
      }
      new Buttons(this);
      if (this.settings.tagging) {
        this.applyTaggedKWIC();
      }
      return this.setActiveTree(this.getIdFromTabName(activeTree));
    }
  };

  View.prototype.setTabResults = function(tree, val) {
    var cjTab, result;
    cjTab = this.cj_menuSelectors.tabs.find(".tab-" + (this.getTabNameFromId(tree, true)));
    if (cjTab.find("span").length > 0) {
      return cjTab.find("span").html("(" + val + ")");
    } else {
      result = cjTab.html();
      return cjTab.html("" + result + "<span>(" + val + ")</span>");
    }
  };

  View.prototype.removeTabCounts = function(id) {
    if (id != null) {
      return this.cj_menuSelectors.tabs.find("." + " span").remove();
    } else {
      return this.cj_menuSelectors.tabs.find("span").remove();
    }
  };

  View.prototype.addPositionReminderText = function(cjlocation) {
    var positionText;
    positionText = "              <div class='position-box-text-reminder'>                Type in a Bill Number or Name for Results              </div>          ";
    return cjlocation.html(positionText);
  };

  View.prototype.toggleTagBox = function() {
    return this.cj_selectors.tagBox.toggle().toggleClass("dropdown");
  };

  View.prototype.toggleDropdown = function(hits) {
    var boxHeight, k, v;
    if (this.cj_selectors.tagBox.hasClass("dropdown")) {
      if (hits != null) {
        for (k in hits) {
          v = hits[k];
          this.getTagHeight(this.cj_selectors.tagBox.find(".top-" + k));
        }
        this.cj_selectors.container.addClass("dropdown");
        this.cj_selectors.tagBox.css("height", "auto").addClass("open").css("overflow-y", "auto");
        this.cj_selectors.tagBox.css("border-right", "1px solid #ccc");
        this.cj_menuSelectors.bottom.find(".JSTree-settings").css("border-bottom", "1px solid #bbb");
        this.setOverlay();
      } else {
        boxHeight = new Resize();
        this.cj_selectors.container.removeClass("dropdown");
        this.cj_selectors.tagBox.removeClass("open").css("overflow-y", "scroll").height(boxHeight.height);
        this.cj_selectors.tagBox.css("border-right", "0px");
        this.cj_menuSelectors.bottom.find(".JSTree-settings").css("border-bottom", "0px");
        this.setOverlay();
      }
    }
    return this.setOverlay();
  };

  View.prototype.getTagHeight = function(tagBox, maxHeight) {
    var checkDTs, closestTo, heightTotal, propHeight, v, _i, _j, _len, _len1;
    if (maxHeight == null) {
      maxHeight = 180;
    }
    checkDTs = [];
    heightTotal = this.getRecTagHeight(tagBox);
    propHeight = 0;
    for (_i = 0, _len = heightTotal.length; _i < _len; _i++) {
      v = heightTotal[_i];
      propHeight += parseInt(v);
    }
    if (propHeight > maxHeight) {
      closestTo = 0;
      for (_j = 0, _len1 = heightTotal.length; _j < _len1; _j++) {
        v = heightTotal[_j];
        if (closestTo > maxHeight) {
          break;
        }
        closestTo += parseInt(v);
      }
      return cj(tagBox).height(closestTo);
    } else {
      return cj(tagBox).height(propHeight);
    }
  };

  View.prototype.getRecTagHeight = function(container, heightTotal, already) {
    var _this = this;
    if (heightTotal == null) {
      heightTotal = [];
    }
    if (heightTotal.length > 8) {
      return heightTotal;
    }
    cj.each(cj(container).find("dt"), function(i, el) {
      var cjEl;
      cjEl = cj(el);
      heightTotal.push(cjEl.height());
      if (heightTotal.length > 8) {
        return false;
      }
    });
    return heightTotal;
  };

  View.prototype.createAction = function(tagId, action, cb) {
    if (tagId == null) {
      tagId = "";
    }
    return new Action(this, this.instance, tagId, action, cb);
  };

  View.prototype.toggleCheckInBox = function() {
    var a;
    a = this;
    this.cj_selectors.tagBox.find("dt input.checkbox").off("change");
    return this.cj_selectors.tagBox.find("dt input.checkbox").on("change", function() {
      var action, addTag, cjDT, doAction, entity, o, removeTag, tagId, toggleClass;
      action = {
        type: "checkbox"
      };
      removeTag = function() {
        var _removeTag,
          _this = this;
        _removeTag = entity.removeTag(tagId);
        return _removeTag.done(function(i) {
          return doAction.apply(null, [i, "remove"]);
        });
      };
      addTag = function() {
        var _addTag,
          _this = this;
        a.addTagsToHolder(cjDT.data("tagid"));
        _addTag = entity.addTag(tagId);
        return _addTag.done(function(i) {
          return doAction.apply(null, [i, "add"]);
        });
      };
      doAction = function(res, typeOfAction) {
        action["action"] = typeOfAction;
        if (res.code !== 1) {
          if (typeOfAction === "add") {
            removeTag.call(null, null);
          }
          if (typeOfAction === "remove") {
            addTag.call(null, null);
          }
        }
        return new ActivityLog(res, action);
      };
      toggleClass = function(cjDT) {
        cjDT.toggleClass("shaded");
        a.hasTaggedChildren(cjDT);
        if (cj(this).prop("checked")) {
          return addTag.call(this, null);
        } else {
          return removeTag.call(this, null);
        }
      };
      entity = a.instance.entity;
      cjDT = cj(this).parents("dt").first();
      if (cjDT.data("tree") === 292 && parseInt(cjDT.data("tagid")) >= 292000) {
        o = this;
        return a.createAction(cjDT.data("tagid"), "addTagFromPosition", function(response) {
          var newDT;
          newDT = response.cjDT;
          if (response === false) {

          } else {
            action.tagId = response["message"]["id"];
            return toggleClass.call(newDT.find("input.checkbox")[0], newDT);
          }
        });
      } else {
        tagId = cjDT.data("tagid");
        action.tagId = tagId;
        return toggleClass.call(this, cjDT);
      }
    });
  };

  View.prototype.hasTaggedChildren = function(cjDT) {
    var cjSiblingDT, dl, i, parentTagId, parents, tagId, _i, _len, _results;
    tagId = cjDT.data("tagid");
    if (cjDT.siblings("#tagDropdown_" + tagId).find("dt.shaded").length > 0) {
      cjDT.addClass("shadedChildren");
    }
    parents = cjDT.parentsUntil(".JSTree", "dl");
    _results = [];
    for (i = _i = 0, _len = parents.length; _i < _len; i = ++_i) {
      dl = parents[i];
      parentTagId = cj(dl).data("tagid");
      cjSiblingDT = this.cj_selectors.tagBox.find("#tagLabel_" + parentTagId);
      if (cj(dl).find("dt.shaded").length > 0) {
        _results.push(cjSiblingDT.addClass("shadedChildren"));
      } else {
        _results.push(cjSiblingDT.removeClass("shadedChildren"));
      }
    }
    return _results;
  };

  return View;

})();

Action = (function() {
  Action.prototype.ajax = {
    addTag: {
      url: '/civicrm/ajax/tag/create',
      data: {
        name: "",
        description: "",
        parent_id: "",
        is_reserved: true
      }
    },
    removeTag: {
      url: '/civicrm/ajax/tag/delete',
      data: {
        id: ""
      }
    },
    updateTag: {
      url: '/civicrm/ajax/tag/update',
      data: {
        name: "",
        description: "",
        id: "",
        is_reserved: true
      }
    },
    moveTag: {
      url: '/civicrm/ajax/tag/update',
      data: {
        id: "",
        parent_id: ""
      }
    },
    convertTag: {
      url: '/civicrm/ajax/tag/update',
      data: {
        id: "",
        parent_id: ""
      }
    },
    mergeTag: {
      url: '/civicrm/ajax/mergeTags',
      type: 'POST',
      data: ""
    }
  };

  Action.prototype.fields = {
    addTag: ["Tag Name", "Description", "Is Reserved"],
    removeTag: [],
    updateTag: ["Tag Name", "Description", "Is Reserved"],
    moveTag: [],
    convertTag: [],
    mergeTag: []
  };

  Action.prototype.requiredFields = {
    addTag: ["Tag Name"],
    removeTag: [],
    updateTag: ["Tag Name"],
    moveTag: [],
    convertTag: [],
    mergeTag: []
  };

  Action.prototype.requiredValidation = {
    addTag: ["isRequired", "appliesNullToText"],
    removeTag: ["noChildren"],
    updateTag: ["isRequired", "appliesNullToText"],
    moveTag: ["noChildren"],
    convertTag: ["noChildren"],
    mergeTag: ["noChildren"]
  };

  function Action(view, instance, tagId, action, cb) {
    var k, v, _ref;
    this.view = view;
    this.instance = instance;
    this.tagId = tagId;
    this.cb = cb;
    _ref = this.ajax;
    for (k in _ref) {
      v = _ref[k];
      v.data["call_uri"] = window.location.href;
      v["dataType"] = "json";
    }
    this.cjDT = this.view.cj_selectors.tagBox.find("dt[data-tagid='" + this.tagId + "']");
    this.tagName = this.cjDT.data("name");
    this[action].apply(this, [action]);
  }

  Action.prototype.createSlide = function(cb) {
    var activeTreeId, containerPosition, menuHeight, resize, sideWidth, slideWidth,
      _this = this;
    resize = new Resize;
    if (resize.height > 190) {
      this.view.cj_selectors.tagBox.addClass("hasSlideBox");
      this.view.cj_selectors.tagBox.prepend("<div class='slideBox'></div>");
      this.bottom = false;
      this.cj_slideBox = this.view.cj_selectors.tagBox.find(".slideBox");
      this.cj_slideBox.css("right", "" + (this.findGutterSpace()) + "px");
      if (this.view.settings.wide) {
        slideWidth = '40%';
      } else {
        sideWidth = '60%';
      }
      return this.cj_slideBox.animate({
        width: slideWidth
      }, 500, function() {
        _this.cj_slideBox.append(_this.slideHtml);
        _this.setCancel();
        return cb();
      });
    } else {
      this.bottom = true;
      this.view.cj_selectors.tagBox.addClass("hasSlideBox");
      containerPosition = this.view.cj_selectors.container.offset();
      menuHeight = this.view.cj_menuSelectors.menu.height();
      activeTreeId = this.view.cj_selectors.tagBox.find(".tagContainer.active").data("treeid");
      this.view.cj_selectors.container.after("<div class='JSTree-slideBox'><div class='slideBox top-" + activeTreeId + "'></div></div>");
      this.cj_slideBoxContainer = cj(".JSTree-slideBox");
      this.cj_slideBoxContainer.css("top", "" + (containerPosition.top + menuHeight) + "px").css("left", "" + containerPosition.left + "px");
      this.cj_slideBox = this.cj_slideBoxContainer.find(".slideBox");
      return this.cj_slideBox.animate({
        height: "210px"
      }, 500, function() {
        _this.cj_slideBox.append(_this.slideHtml);
        _this.setCancel();
        return cb();
      });
    }
  };

  Action.prototype.setCancel = function() {
    var _this = this;
    this.cj_slideBox.find(".label.cancel").off("click");
    return this.cj_slideBox.find(".label.cancel").on("click", function() {
      return _this.destroySlideBox();
    });
  };

  Action.prototype.destroySlideBox = function() {
    var animate,
      _this = this;
    this.cj_slideBox.empty();
    if (this.bottom) {
      animate = {
        height: "0px"
      };
    } else {
      animate = {
        width: "0%"
      };
    }
    return this.cj_slideBox.animate(animate, 500, function() {
      _this.cj_slideBox.find(".label.cancel").off("click");
      _this.cj_slideBox.remove();
      _this.view.cj_selectors.tagBox.removeClass("hasSlideBox").removeClass("radio");
      _this.view.createTabClick();
      if (_this.cj_slideBoxContainer != null) {
        _this.cj_slideBoxContainer.remove();
      }
      return new Buttons(_this.view);
    });
  };

  Action.prototype.addTagFromPosition = function(tagId, action) {
    var cjDT, k, manipBox, message, response, v, _ref,
      _this = this;
    manipBox = function(tagId, messageId) {
      var cjDL;
      cjDL = _this.view.cj_selectors.tagBox.find("#tagDropdown_" + tagId);
      cjDL.attr("id", "tagDropdown_" + messageId);
      cjDL.data("tagid", messageId);
      cjDT.data("tagid", messageId);
      cjDT.attr("id", "tagLabel_" + messageId);
      cjDT.removeClass("tag-" + tagId).addClass("tag-" + messageId);
      return cjDT.find("input.checkbox").attr("name", "tag[" + messageId + "]");
    };
    cjDT = this.view.cj_selectors.tagBox.find("#tagLabel_" + tagId);
    this.ajax.addTag.data.name = cjDT.find(".tag .name").text();
    this.ajax.addTag.data.description = cjDT.find(".tag .description").text();
    this.ajax.addTag.data.parent_id = "292";
    this.ajax.addTag.data.is_reserved = true;
    _ref = this.instance.positionList;
    for (k in _ref) {
      v = _ref[k];
      if (_utils.removePositionTextFromBill(this.ajax.addTag.data.name) === v.name) {
        if (_utils.checkPositionFromBill(this.ajax.addTag.data.name) === v.pos) {
          manipBox.call(this, cjDT.data("tagid"), v.id);
          message = {
            id: v.id
          };
          response = {
            "cjDT": cjDT,
            "message": message
          };
          this.cb(response);
        }
      }
    }
    return this.tagAjax(tagId, "addTag", action, function(message) {
      if (message === "DB Error: already exists") {
        cjDT.prop("checked", false);
        if (_this.cb != null) {
          response = {
            "cjDT": cjDT,
            "message": message
          };
          _this.cb(response);
        }
      }
      manipBox.call(_this, tagId, message.id);
      if (_this.cb != null) {
        response = {
          "cjDT": cjDT,
          "message": message
        };
        return _this.cb(response);
      }
    });
  };

  Action.prototype.findGutterSpace = function() {
    var innerWidth, outerWidth;
    outerWidth = this.view.cj_selectors.tagBox.width();
    innerWidth = this.view.cj_selectors.tagBox.find(".tagContainer.active").width();
    return outerWidth - innerWidth;
  };

  Action.prototype.setRequiredFields = function(type) {
    var i, reqFields, _i, _len;
    reqFields = this.requiredFields[type];
    this.requiredFields = [];
    for (_i = 0, _len = reqFields.length; _i < _len; _i++) {
      i = reqFields[_i];
      this.requiredFields.push(_utils.camelCase(i));
    }
    return this.requiredValidation = this.requiredValidation[type];
  };

  Action.prototype.addTag = function(values) {
    var _this = this;
    if (values == null) {
      values = "";
    }
    this.slideHtml = this.gatherLabelHTML();
    this.setRequiredFields("addTag");
    return this.createSlide(function() {
      var doSubmit;
      _this.view.unbindTabClick();
      doSubmit = function() {
        return _this.submitButton(true, function(data) {
          _this.removeErrors(data);
          if (bbUtils.objSize(data.errors) > 0) {
            return _this.markErrors(data.errors);
          } else {
            _this.ajax.addTag.data.name = data.fields.tagName;
            _this.ajax.addTag.data.description = data.fields.description;
            _this.ajax.addTag.data.is_reserved = data.fields.isReserved;
            _this.ajax.addTag.data.parent_id = data.tagId;
            _this.convertSubmitToLoading();
            return _this.tagAjax(data.tagId, "addTag", void 0, function(message) {
              if (message === "DB Error: already exists") {
                _this.revertSubmitFromLoading();
                _this.markErrors({
                  tagName: "Tag " + data.fields.tagName + " already exists."
                });
                return doSubmit.call(_this);
              } else {
                _this.addEntityToTree(data.tagId, message);
                _this.revertSubmitFromLoading();
                return _this.destroySlideBox();
              }
            });
          }
        });
      };
      return doSubmit.call(_this);
    });
  };

  Action.prototype.removeTag = function() {
    var _this = this;
    this.slideHtml = this.gatherRemoveLabelHTML();
    this.setRequiredFields("removeTag");
    return this.createSlide(function() {
      var doSubmit;
      _this.view.unbindTabClick();
      doSubmit = function() {
        return _this.submitButton(true, function(data) {
          _this.removeErrors(data);
          if (bbUtils.objSize(data.errors) > 0) {
            return _this.markErrors(data.errors);
          } else {
            _this.ajax.removeTag.data.id = data.tagId;
            _this.convertSubmitToLoading();
            return _this.tagAjax(data.tagId, "removeTag", void 0, function(message) {
              if (message === "DB Error: already exists") {
                _this.revertSubmitFromLoading();
                _this.markErrors({
                  tagName: "Tag " + data.fields.tagName + " cannot be removed."
                });
                return doSubmit.call(_this);
              } else {
                _this.removeEntityFromTree(data.id);
                _this.revertSubmitFromLoading();
                return _this.destroySlideBox();
              }
            });
          }
        });
      };
      return doSubmit.call(_this);
    });
  };

  Action.prototype.sendDtToPanel = function(cjDT) {
    this.cj_slideBox.find(".toTag").removeClass("errorLabel");
    return this.cj_slideBox.find(".toTag").html(cjDT.data("name"));
  };

  Action.prototype.moveTag = function() {
    var a, buttons,
      _this = this;
    this.slideHtml = this.gatherMoveLabelHTML();
    this.setRequiredFields("moveTag");
    this.view.cj_selectors.tagBox.addClass("radio");
    buttons = new Buttons(this.view, this.cjDT.data("tagid"), true);
    a = this;
    this.view.cj_selectors.tagBox.find("dt input.radio").on("click", function(event) {
      a.cj_slideBox.find(".submit").removeClass("inactive");
      return a.sendDtToPanel(cj(this).closest("dt"));
    });
    return this.createSlide(function() {
      var doSubmit;
      _this.view.unbindTabClick();
      _this.cj_slideBox.find(".submit").addClass("inactive");
      doSubmit = function() {
        return _this.submitButton(true, function(data) {
          if (_this.cj_slideBox.find(".submit").hasClass("inactive")) {
            return _this.markErrors({
              toTag: "Must specify a destination"
            });
          } else {
            _this.removeErrors(data);
            if (bbUtils.objSize(data.errors) > 0) {
              return _this.markErrors(data.errors);
            } else {
              _this.ajax.moveTag.data.parent_id = _this.view.cj_selectors.tagBox.find("input[name=tag]:checked").attr("value");
              data.id = _this.cjDT.data("tagid");
              _this.ajax.moveTag.data.id = data.id;
              _this.convertSubmitToLoading();
              return _this.tagAjax(data.id, "moveTag", void 0, function(message) {
                if (message == null) {
                  console.log("no response");
                }
                if (message.code != null) {
                  _this.revertSubmitFromLoading();
                  _this.markErrors({
                    tagName: "Tag " + data.fields.tagName + " cannot be removed."
                  });
                  return doSubmit.call(_this);
                } else {
                  _this.removeEntityFromTree(data.id);
                  _this.addEntityToTree(_this.ajax.moveTag.data.parent_id, message);
                  _this.revertSubmitFromLoading();
                  return _this.destroySlideBox();
                }
              });
            }
          }
        });
      };
      return doSubmit.call(_this);
    });
  };

  Action.prototype.convertTag = function() {
    var a, buttons,
      _this = this;
    this.slideHtml = this.gatherConvertLabelHTML();
    this.setRequiredFields("convertTag");
    this.view.cj_selectors.tagBox.addClass("radio");
    buttons = new Buttons(this.view, this.cjDT.data("tagid"), true);
    a = this;
    this.view.cj_selectors.tagBox.find("dt input.radio").on("click", function(event) {
      a.cj_slideBox.find(".submit").removeClass("inactive");
      return a.sendDtToPanel(cj(this).closest("dt"));
    });
    return this.createSlide(function() {
      var doSubmit;
      _this.view.unbindTabClick();
      _this.cj_slideBox.find(".submit").addClass("inactive");
      _this.view.showTags(291, "issue-codes");
      doSubmit = function() {
        return _this.submitButton(true, function(data) {
          if (_this.cj_slideBox.find(".submit").hasClass("inactive")) {
            return _this.markErrors({
              toTag: "Must specify a destination"
            });
          } else {
            _this.removeErrors(data);
            if (bbUtils.objSize(data.errors) > 0) {
              return _this.markErrors(data.errors);
            } else {
              _this.ajax.moveTag.data.parent_id = _this.view.cj_selectors.tagBox.find("input[name=tag]:checked").attr("value");
              data.id = _this.cjDT.data("tagid");
              _this.ajax.moveTag.data.id = data.id;
              _this.convertSubmitToLoading();
              return _this.tagAjax(data.id, "convertTag", void 0, function(message) {
                if (message == null) {
                  console.log("no response");
                }
                if (message.code != null) {
                  _this.revertSubmitFromLoading();
                  _this.markErrors({
                    tagName: "Tag " + data.fields.tagName + " cannot be removed."
                  });
                  return doSubmit.call(_this);
                } else {
                  _this.removeEntityFromTree(data.id);
                  _this.addEntityToTree(_this.ajax.moveTag.data.parent_id, message);
                  _this.revertSubmitFromLoading();
                  return _this.destroySlideBox();
                }
              });
            }
          }
        });
      };
      return doSubmit.call(_this);
    });
  };

  Action.prototype.mergeTag = function() {
    var a, buttons,
      _this = this;
    this.slideHtml = this.gatherMergeLabelHTML();
    this.setRequiredFields("mergeTag");
    this.view.cj_selectors.tagBox.addClass("radio");
    buttons = new Buttons(this.view, this.cjDT.data("tagid"), true);
    a = this;
    this.view.cj_selectors.tagBox.find("dt input.radio").on("click", function(event) {
      a.cj_slideBox.find(".submit").removeClass("inactive");
      return a.sendDtToPanel(cj(this).closest("dt"));
    });
    return this.createSlide(function() {
      var doSubmit;
      _this.view.unbindTabClick();
      _this.cj_slideBox.find(".submit").addClass("inactive");
      doSubmit = function() {
        return _this.submitButton(true, function(data) {
          var currentId, destinationId;
          if (_this.cj_slideBox.find(".submit").hasClass("inactive")) {
            return _this.markErrors({
              toTag: "Must specify a destination"
            });
          } else {
            _this.removeErrors(data);
            if (bbUtils.objSize(data.errors) > 0) {
              return _this.markErrors(data.errors);
            } else {
              destinationId = _this.view.cj_selectors.tagBox.find("input[name=tag]:checked").attr("value");
              currentId = _this.cjDT.data("tagid");
              _this.ajax.mergeTag.data = "fromId=" + currentId + "&toId=" + destinationId;
              _this.convertSubmitToLoading();
              return _this.tagAjax(currentId, "mergeTag", void 0, function(message) {
                if (!message.status) {
                  _this.revertSubmitFromLoading();
                  _this.markErrors({
                    tagName: "" + message.message
                  });
                  return doSubmit.call(_this);
                } else {
                  _this.removeEntityFromTree(currentId);
                  _this.revertSubmitFromLoading();
                  return _this.destroySlideBox();
                }
              });
            }
          }
        });
      };
      return doSubmit.call(_this);
    });
  };

  Action.prototype.updateTag = function() {
    var checked, values,
      _this = this;
    checked = "";
    if (this.cjDT.data("isreserved") === 1) {
      checked = "checked";
    }
    values = {
      tagName: this.cjDT.data("name"),
      description: this.cjDT.find(".tag .description").text() || "",
      isReserved: checked
    };
    this.slideHtml = this.gatherUpdateLabelHTML(values);
    this.setRequiredFields("updateTag");
    return this.createSlide(function() {
      var doSubmit;
      _this.view.unbindTabClick();
      doSubmit = function() {
        return _this.submitButton(true, function(data) {
          _this.removeErrors(data);
          if (bbUtils.objSize(data.errors) > 0) {
            return _this.markErrors(data.errors);
          } else {
            _this.ajax.updateTag.data.name = data.fields.tagName;
            _this.ajax.updateTag.data.description = data.fields.description;
            _this.ajax.updateTag.data.is_reserved = data.fields.isReserved;
            _this.ajax.updateTag.data.id = data.tagId;
            _this.convertSubmitToLoading();
            return _this.tagAjax(data.tagId, "updateTag", void 0, function(message) {
              if (message === "DB Error: already exists") {
                _this.revertSubmitFromLoading();
                _this.markErrors({
                  tagName: "Tag " + data.fields.tagName + " already exists."
                });
                return doSubmit.call(_this);
              } else {
                _this.updateEntity(message);
                _this.revertSubmitFromLoading();
                return _this.destroySlideBox();
              }
            });
          }
        });
      };
      return doSubmit.call(_this);
    });
  };

  Action.prototype.addEntityToTree = function(parent, message) {
    var backout, cjParent, node, node_parsed;
    node = {};
    if ((message.created_date != null) && message.created_date.length > 0) {
      node.created_date = _manipTags.createDate(message.created_date);
    }
    if (message.name != null) {
      node.name = message.name;
    }
    if (message.description != null) {
      if (message.description === null) {
        node.description = "";
      } else {
        node.description = message.description;
      }
    }
    if (message.parent_id != null) {
      node.parent = node.parent_id = message.parent_id;
    }
    if (message.id != null) {
      node.id = message.id;
    }
    node.children = false;
    cjParent = this.view.cj_selectors.tagBox.find("dt#tagLabel_" + parent);
    node.level = cjParent.data("level") + 1;
    node.type = ("" + (cjParent.data("tree"))) || "291";
    if (message.is_reserved = "false") {
      node.is_reserved = "0";
    } else {
      node.is_reserved = "1";
    }
    node_parsed = new Node(node);
    this.instance.appendToAC(node);
    backout = this.view.trees[parseInt(node.type)].appendNode(node, node.parent_id, node_parsed.html);
    _treeUtils.makeDropdown(this.view.cj_selectors.tagBox.find(".top-" + node.type));
    if (!backout) {
      console.log("bad things happened");
      return false;
    }
    return new Buttons(this.view, "#tagLabel_" + node.id);
  };

  Action.prototype.removeEntityFromTree = function() {
    var cjDL, id, nodeType;
    id = this.cjDT.data("tagid");
    cjDL = this.view.cj_selectors.tagBox.find("dl#tagDropdown_" + id);
    nodeType = this.cjDT.data("tree");
    this.instance.removeFromAC(id);
    return this.view.trees[parseInt(nodeType)].removeNode(id);
  };

  Action.prototype.updateEntity = function(message) {
    var backout, cjDL, cjDT, cjNode, data, id, node, nodeDL, settings;
    data = {};
    id = message.id;
    data.id = "" + id;
    data.is_reserved = "0";
    if (message.is_reserved === "true" || message.is_reserved === true) {
      data.is_reserved = "1";
    }
    cjDT = this.view.cj_selectors.tagBox.find("dt#tagLabel_" + id);
    cjDL = this.view.cj_selectors.tagBox.find("dl#tagDropdown_" + id);
    data.parent_id = "" + (cjDT.data('parentid'));
    data.children = false;
    if (cjDL.children().length > 0) {
      data.children = true;
    }
    data.level = parseInt(cjDT.data("level"));
    data.type = "" + (cjDT.data("tree"));
    data.name = message.name;
    data.description = message.description;
    node = Object.getPrototypeOf(this.view.trees[cjDT.data("tree")]).nodeList[id];
    settings = cj.extend({}, node.data, data);
    node.setValues(settings);
    backout = this.view.trees[parseInt(data.type)].appendNode(settings, settings.parent_id, node.html, true);
    this.instance.appendToAC(settings);
    cjNode = cj("<div>" + node.html + "</div>");
    if (cjDT.hasClass("open")) {
      cjNode.find("#tagLabel_" + id).addClass("open");
    }
    if (node.children) {
      nodeDL = cjNode.find("#tagDropdown_" + id);
      nodeDL.replaceWith(cjDL[0].outerHTML);
    }
    cjDL.remove();
    cjDT.replaceWith(cjNode.html());
    _treeUtils.makeDropdown(this.view.cj_selectors.tagBox.find(".top-" + node.type));
    new Buttons(this.view, "#tagDropdown_" + id);
    return new Buttons(this.view, "#tagLabel_" + id);
  };

  Action.prototype.removeErrors = function(data) {
    var cjEl, k, notErrored, nowGood, oldName, v, _i, _len, _ref, _results;
    notErrored = [];
    _ref = data.fields;
    for (k in _ref) {
      v = _ref[k];
      if (data.errors[k] == null) {
        notErrored.push(k);
      }
    }
    _results = [];
    for (_i = 0, _len = notErrored.length; _i < _len; _i++) {
      nowGood = notErrored[_i];
      cjEl = this.cj_slideBox.find(".label." + nowGood);
      oldName = cjEl.data("oldname");
      cjEl.removeClass("errorLabel").text(oldName);
      _results.push(this.cj_slideBox.find("input[name='" + nowGood + "']").removeClass("errorBox"));
    }
    return _results;
  };

  Action.prototype.markErrors = function(errors) {
    var cjEl, k, v, _results;
    _results = [];
    for (k in errors) {
      v = errors[k];
      cjEl = this.cj_slideBox.find(".label." + k);
      if (!cjEl.hasClass("errorLabel")) {
        cjEl.data("oldname", cjEl.text());
        cjEl.addClass("errorLabel").text(v);
      }
      _results.push(this.cj_slideBox.find("input[name='" + k + "']").addClass("errorBox"));
    }
    return _results;
  };

  Action.prototype.gatherValuesFromSlideBox = function() {
    var cjFields, data,
      _this = this;
    cjFields = this.cj_slideBox.find("input");
    data = {
      tagId: this.cjDT.data("tagid"),
      fields: {},
      errors: {}
    };
    cj.each(cjFields, function(i, el) {
      var cjEl;
      cjEl = cj(el);
      if (cjEl.attr("type").toLowerCase() === "checkbox") {
        return data.fields[cjEl.attr("name")] = cjEl.prop("checked");
      } else {
        return data.fields[cjEl.attr("name")] = cjEl.val();
      }
    });
    return this.validateValues(data);
  };

  Action.prototype.revertSubmitFromLoading = function() {
    var cjSubmitButton, text;
    cjSubmitButton = this.cj_slideBox.find(".label.submit");
    cjSubmitButton.removeClass("loadingGif");
    text = cjSubmitButton.data("text");
    return cjSubmitButton.text(text);
  };

  Action.prototype.convertSubmitToLoading = function() {
    var cjSubmitButton;
    this.cj_slideBox.find(".label.cancel").addClass("inactive");
    cjSubmitButton = this.cj_slideBox.find(".label.submit");
    cjSubmitButton.addClass("loadingGif");
    cjSubmitButton.data("text", cjSubmitButton.text());
    return cjSubmitButton.text("");
  };

  Action.prototype.validateValues = function(data) {
    var cjEl, k, test, v, validations, _i, _j, _len, _len1, _ref, _ref1, _ref2,
      _this = this;
    validations = {
      createError: function(name, val) {
        var niceName;
        niceName = _this.cjDT.data("name");
        val = "" + niceName + " " + val;
        return data.errors[name] = val;
      },
      isString: function(name, val) {
        return validations.createError.call(this, name, "cannot contain numbers or symbols.");
      },
      appliesNullToText: function(name, val) {
        var noSpaces, passing;
        passing = true;
        if (val.length > 0) {
          noSpaces = val.replace(/\ /g, "");
          if (noSpaces.length === 0) {
            passing = false;
          }
        } else {
          passing = false;
        }
        if (!passing) {
          return data.fields[name] = null;
        }
      },
      noSpaces: function(name, val) {
        return validations.createError.call(this, name, "cannot be contain spaces.");
      },
      isRequired: function(name, val) {
        var noSpaces, passing;
        if (this.requiredFields.indexOf(name) !== -1) {
          passing = true;
          if (val.length > 0) {
            noSpaces = val.replace(/\ /g, "");
            if (noSpaces.length === 0) {
              passing = false;
            }
          } else {
            passing = false;
          }
          if (!passing) {
            return validations.createError.call(this, name, "is required.");
          }
        }
      },
      noChildren: function(tagId) {
        var cjDL, name, passing;
        cjDL = cj(".JSTree #tagDropdown_" + tagId);
        passing = true;
        if (cjDL.children().length > 0) {
          passing = false;
        }
        name = cjDL.data("name");
        if (!passing) {
          return validations.createError.call(this, "headerdescription", "cannot be deleted because it has children.");
        }
      }
    };
    _ref = data.fields;
    for (k in _ref) {
      v = _ref[k];
      cjEl = this.cj_slideBox.find("input[name='" + k + "']");
      if (cjEl.attr("name").toLowerCase() === "checkbox") {
        continue;
      }
      _ref1 = this.requiredValidation;
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        test = _ref1[_i];
        validations[test].call(this, k, v);
      }
    }
    if (bbUtils.objSize(data.fields) === 0) {
      _ref2 = this.requiredValidation;
      for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
        test = _ref2[_j];
        validations[test].call(this, data.tagId);
      }
    }
    return data;
  };

  Action.prototype.submitButton = function(gather, cb) {
    var _this = this;
    return this.cj_slideBox.find(".label.submit").on("click", function() {
      if (gather) {
        return cb(_this.gatherValuesFromSlideBox());
      } else {
        return true;
      }
    });
  };

  Action.prototype.gatherLabelHTML = function(values) {
    var field, html, label, _i, _len, _ref;
    if (values == null) {
      values = "";
    }
    label = new Label;
    html = "";
    if (this.tagName != null) {
      html += label.buildLabel("header", "Add Tag", "Add Tag Under:");
      html += label.buildLabel("headerdescription", "headerdescription", "" + this.tagName);
    } else {
      html += label.buildLabel("header", "Add Tag", "Add Tag");
    }
    _ref = this.fields.addTag;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      field = _ref[_i];
      html += "<div class='elementGroup'>";
      html += label.buildLabel("label", field, field);
      if (field === "Is Reserved") {
        html += label.buildLabel("checkBox", field, "");
      } else {
        html += label.buildLabel("textBox", field, "");
      }
      html += "</div>";
    }
    html += "<div class='actionButtons'>";
    html += label.buildLabel("submit", "", "submit");
    html += label.buildLabel("cancel", "", "cancel");
    html += "</div>";
    return html;
  };

  Action.prototype.gatherUpdateLabelHTML = function(values) {
    var field, html, label, _i, _len, _ref;
    if (values == null) {
      values = "";
    }
    label = new Label;
    html = "";
    if (this.tagName != null) {
      html += label.buildLabel("header", "Update Tag", "Update Tag:");
      html += label.buildLabel("headerdescription", "headerdescription", "" + this.tagName);
    } else {
      html += label.buildLabel("header", "Update Tag", "Update Tag");
    }
    _ref = this.fields.addTag;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      field = _ref[_i];
      html += "<div class='elementGroup'>";
      html += label.buildLabel("label", field, field);
      if (field === "Is Reserved") {
        html += label.buildLabel("checkBox", field, values[_utils.camelCase(field)]);
      } else {
        html += label.buildLabel("textBox", field, values[_utils.camelCase(field)]);
      }
      html += "</div>";
    }
    html += "<div class='actionButtons'>";
    html += label.buildLabel("submit", "", "submit");
    html += label.buildLabel("cancel", "", "cancel");
    html += "</div>";
    return html;
  };

  Action.prototype.gatherRemoveLabelHTML = function(values) {
    var html, label;
    if (values == null) {
      values = "";
    }
    label = new Label;
    html = "";
    if (this.tagName != null) {
      html += label.buildLabel("header", "Remove Tag", "Remove Tag:");
      html += label.buildLabel("headerdescription", "headerdescription", "" + this.tagName);
    } else {
      html += label.buildLabel("error", "error", "Cannot Find Tag to Remove");
      return html;
    }
    html += "<div class='actionButtons'>";
    html += label.buildLabel("submit", "", "submit");
    html += label.buildLabel("cancel", "", "cancel");
    html += "</div>";
    return html;
  };

  Action.prototype.gatherMoveLabelHTML = function(values) {
    var html, label;
    if (values == null) {
      values = "";
    }
    label = new Label;
    html = "";
    html += "<div class='openArrow'></div>";
    if (this.tagName != null) {
      html += label.buildLabel("header", "Move Tag", "Move Tag:");
      html += label.buildLabel("headerdescription", "headerdescription", "" + this.tagName);
      html += label.buildLabel("header", "header3", "to");
      html += label.buildLabel("headerdescription", "To Tag", "");
    } else {
      html += label.buildLabel("error", "error", "Cannot Find Tag to Move");
      return html;
    }
    html += "<div class='actionButtons'>";
    html += label.buildLabel("submit", "", "submit");
    html += label.buildLabel("cancel", "", "cancel");
    html += "</div>";
    return html;
  };

  Action.prototype.gatherConvertLabelHTML = function(values) {
    var html, label;
    if (values == null) {
      values = "";
    }
    label = new Label;
    html = "";
    html += "<div class='openArrow'></div>";
    if (this.tagName != null) {
      html += label.buildLabel("header", "Convert Tag", "Convert Keyword:");
      html += label.buildLabel("headerdescription", "headerdescription", "" + this.tagName);
      html += label.buildLabel("header", "header3", "To Issue Code Under:");
      html += label.buildLabel("headerdescription", "To Tag", "");
    } else {
      html += label.buildLabel("error", "error", "Cannot Find Tag to Place Keyword Under");
      return html;
    }
    html += "<div class='actionButtons'>";
    html += label.buildLabel("submit", "", "submit");
    html += label.buildLabel("cancel", "", "cancel");
    html += "</div>";
    return html;
  };

  Action.prototype.gatherMergeLabelHTML = function(values) {
    var html, label;
    if (values == null) {
      values = "";
    }
    label = new Label;
    html = "";
    html += "<div class='openArrow'></div>";
    if (this.tagName != null) {
      html += label.buildLabel("header", "Merge Tag", "Merge Tag:");
      html += label.buildLabel("headerdescription", "headerdescription", "" + this.tagName);
      html += label.buildLabel("header", "header3", "Into");
      html += label.buildLabel("headerdescription", "To Tag", "");
    } else {
      html += label.buildLabel("error", "error", "Cannot Find Tag to Merge");
      return html;
    }
    html += "<div class='actionButtons'>";
    html += label.buildLabel("submit", "", "submit");
    html += label.buildLabel("cancel", "", "cancel");
    html += "</div>";
    return html;
  };

  Action.prototype.tagAjax = function(tagId, type, action, locCb) {
    var request,
      _this = this;
    request = cj.when(cj.ajax(this.ajax[type]));
    request.done(function(data) {
      if (locCb != null) {
        if (data.code === 0) {
          return locCb(data);
        } else {
          if (data["status"] === true) {
            return locCb(data);
          } else {
            return locCb(data.message);
          }
        }
      } else if (_this.cb != null) {
        return _this.cb(data.message);
      }
    });
    return this;
  };

  return Action;

})();

_manipTags = {
  createDate: function(mDate) {
    var date;
    date = "";
    date += "" + (mDate.substring(0, 4)) + "-";
    date += "" + (mDate.substring(4, 6)) + "-";
    date += "" + (mDate.substring(6, 8)) + " ";
    date += "" + (mDate.substring(8, 10)) + ":";
    date += "" + (mDate.substring(10, 12)) + ":";
    date += "" + (mDate.substring(12, 14));
    return date;
  }
};

Label = (function() {
  function Label() {}

  Label.prototype.defaults = {
    header: {
      className: "label header",
      value: "Header"
    },
    label: {
      className: "label",
      value: "Label"
    },
    textBox: {
      className: "textBox",
      value: "",
      name: ""
    },
    submit: {
      className: "label submit",
      value: "Submit"
    },
    checkBox: {
      className: "checkBox",
      value: ""
    },
    cancel: {
      className: "label cancel",
      value: "Cancel"
    },
    headerdescription: {
      className: "label headerDescription",
      value: ""
    },
    error: {
      className: "label error",
      value: ""
    }
  };

  Label.prototype.buildLabel = function(type, className, value) {
    this.passed = {
      className: _utils.camelCase(className),
      value: value
    };
    if (["header", "label", "submit", "headerdescription", "cancel", "error"].indexOf(type) > -1) {
      return this.label(type);
    } else {
      return this[type].call(this, null);
    }
  };

  Label.prototype.label = function(type) {
    var _base;
    if ((_base = this.passed).value == null) {
      _base.value = this.defaults[type].value;
    }
    return "<div class='" + this.defaults[type].className + " " + this.passed.className + "'>" + this.passed.value + "</div>";
  };

  Label.prototype.textBox = function() {
    var _base, _base1;
    if ((_base = this.passed).className == null) {
      _base.className = this.defaults.textBox.className;
    }
    if ((_base1 = this.passed).value == null) {
      _base1.value = this.defaults.textBox.value;
    }
    return "<input type='text' class='" + this.defaults.textBox.className + " " + this.passed.className + "' name='" + this.passed.className + "' value='" + this.passed.value + "'>";
  };

  Label.prototype.checkBox = function() {
    var _base;
    if ((_base = this.passed).className == null) {
      _base.className = this.defaults.textBox.className;
    }
    return "<input type='checkbox' class='" + this.defaults.checkBox.className + " " + this.passed.className + "' name='" + this.passed.className + "' " + this.passed.value + ">";
  };

  return Label;

})();

Buttons = (function() {
  Buttons.prototype.checkbox = "<input type='checkbox' class='checkbox'>";

  Buttons.prototype.addTag = "<li class='addTag' title='Add New Tag' data-do='add'></li>";

  Buttons.prototype.removeTag = "<li class='removeTag' title='Remove Tag' data-do='remove'></li>";

  Buttons.prototype.moveTag = "<li class='moveTag' title='Move Tag' data-do='move'></li>";

  Buttons.prototype.updateTag = "<li class='updateTag' title='Update Tag' data-do='update'></li>";

  Buttons.prototype.mergeTag = "<li class='mergeTag' title='Merge Tag' data-do='merge'></li>";

  Buttons.prototype.convertTag = "<li class='convertTag' title='Convert Keyword' data-do='convert'></li>";

  Buttons.prototype.keywords = ["removeTag", "updateTag", "mergeTag", "convertTag"];

  Buttons.prototype.issuecodes = ["addTag", "removeTag", "updateTag", "moveTag", "mergeTag"];

  Buttons.prototype.radioButtons = false;

  function Buttons(view, finder, radio) {
    this.view = view;
    if (finder == null) {
      finder = "";
    }
    if (radio === true) {
      this.removeTaggingCheckboxes();
      this.removeFCB();
      this.radioButtons = true;
      this.createRadioButtons(finder);
    } else {
      this.removeRadioButtons();
      if (this.view.settings.tagging) {
        this.removeFCB();
        this.createTaggingCheckboxes(finder);
      }
      if (this.view.settings.edit) {
        this.removeTaggingCheckboxes();
        this.createFCB();
      }
    }
  }

  Buttons.prototype.createTaggingCheckboxes = function(finder) {
    var a;
    a = this;
    this.view.cj_selectors.tagBox.find("" + finder + " dt .tag .name").before(function() {
      if (cj(this).siblings(".fCB").length === 0) {
        return a.createButtons(cj(this).parent().parent().data("tagid"));
      }
    });
    return this.view.toggleCheckInBox();
  };

  Buttons.prototype.removeTaggingCheckboxes = function() {
    return this.view.cj_selectors.tagBox.find("dt .tag .fCB").remove();
  };

  Buttons.prototype.createRadioButtons = function(finder) {
    var a;
    a = this;
    return this.view.cj_selectors.tagBox.find("dt .tag .name").before(function() {
      if (cj(this).parent().parent().data("tagid") !== finder) {
        return a.createButtons(cj(this).parent().parent().data("tagid"));
      }
    });
  };

  Buttons.prototype.removeRadioButtons = function() {
    var cjDT;
    cjDT = this.view.cj_selectors.tagBox.find("dt");
    cjDT.find(".tag .fCB").remove();
    return cjDT.off("click");
  };

  Buttons.prototype.createFCB = function() {
    var cjTreeTop, k, v, _ref, _results,
      _this = this;
    if (this.nodeList == null) {
      this.nodeList = this.view._trees[291].nodeList;
    }
    _ref = this.view._trees;
    _results = [];
    for (k in _ref) {
      v = _ref[k];
      cjTreeTop = this.view.cj_selectors.tagBox.find(".top-" + k).find("dt");
      cjTreeTop.off("mouseenter");
      cjTreeTop.off("mouseleave");
      cjTreeTop.on("mouseenter", function(tag) {
        var cjDT;
        cjDT = cj(tag.currentTarget);
        cjDT.find(".tag").append(_this.createButtons(cjDT.data("tree")));
        return _this.executeButton(cjDT);
      });
      _results.push(cjTreeTop.on("mouseleave", function(tag) {
        var cjDT;
        cjDT = cj(tag.currentTarget).find(".tag .fCB");
        return cjDT.remove();
      }));
    }
    return _results;
  };

  Buttons.prototype.removeFCB = function() {
    var cjTreeTop, k, v, _ref, _results;
    _ref = this.view._trees;
    _results = [];
    for (k in _ref) {
      v = _ref[k];
      cjTreeTop = this.view.cj_selectors.tagBox.find(".top-" + k).find("dt");
      cjTreeTop.off("mouseenter");
      cjTreeTop.off("mouseleave");
      cjTreeTop.off("click");
      _results.push(cjTreeTop.find(".fCB").remove());
    }
    return _results;
  };

  Buttons.prototype.createButtons = function(treeTop) {
    var html, tag, _i, _j, _len, _len1, _ref, _ref1;
    html = "<div class='fCB'>";
    html += "<ul>";
    if (this.radioButtons) {
      html += "<li>";
      html += _utils.createRadioButton("tag", "" + treeTop, "radio");
      html += "</li>";
    } else {
      if (this.view.settings.edit) {
        if (parseInt(treeTop) === 291) {
          _ref = this.issuecodes;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            tag = _ref[_i];
            html += this[tag];
          }
        }
        if (parseInt(treeTop) === 296) {
          _ref1 = this.keywords;
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            tag = _ref1[_j];
            html += this[tag];
          }
        }
      } else {
        if (this.view.settings.tagging) {
          html += "<li>";
          html += _utils.createCheckBox("tag[" + treeTop + "]", "", "checkbox");
          html += "</li>";
        }
      }
    }
    html += "</ul>";
    return html += "</div>";
  };

  Buttons.prototype.executeButton = function(cjDT) {
    var _this = this;
    cjDT.off("click");
    if (this.view.settings.edit) {
      return cjDT.on("click", "li", function(button) {
        var action, tagid;
        action = "" + (cj(button.target).data("do")) + "Tag";
        tagid = cjDT.data("tagid");
        return _this.view.createAction(tagid, action);
      });
    } else {
      return cjDT.on("click", "li", function(button) {});
    }
  };

  return Buttons;

})();

ActivityLog = (function() {
  function ActivityLog(jsonObj, action) {}

  return ActivityLog;

})();

Settings = (function() {
  var icons;

  function Settings(instance, view) {
    this.instance = instance;
    this.view = view;
    this.createButtons();
  }

  Settings.prototype.createButtons = function() {
    var a, b, _i, _j, _len, _len1, _ref, _ref1, _results;
    this.cj_top_settings = cj("." + (this.view.menuSelectors.top.split(" ").join(".")) + " ." + (this.view.menuSelectors.settings.split(" ").join(".")));
    this.cj_bottom_settings = cj("." + (this.view.menuSelectors.bottom.split(" ").join(".")) + " ." + (this.view.menuSelectors.settings.split(" ").join(".")));
    _ref = icons.top;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      a = _ref[_i];
      this.cj_top_settings.append(this.addButton(a));
    }
    _ref1 = icons.bottom;
    _results = [];
    for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
      b = _ref1[_j];
      _results.push(this.cj_bottom_settings.append(this.addButton(b)));
    }
    return _results;
  };

  icons = {
    top: ['setting', 'add', 'print'],
    bottom: ['slide']
  };

  Settings.prototype.addButton = function(name) {
    return "<div class='" + name + "'></div>";
  };

  return Settings;

})();

Resize = (function() {
  function Resize(boxHeight) {
    var lsheight;
    if (boxHeight != null) {
      bbUtils.localStorage("tagBoxHeight", boxheight);
      return boxHeight;
    }
    if (bbUtils.localStorage("tagBoxHeight") != null) {
      lsheight = bbUtils.localStorage("tagBoxHeight");
      if (lsheight.height > 600) {
        bbUtils.localStorage("tagBoxHeight", 600);
        lsheight.height = 600;
      }
      this.height = lsheight.height;
    } else {
      this.height = 400;
    }
  }

  Resize.prototype.addResize = function(instance, view) {
    var displaySettings, maxHeight,
      _this = this;
    this.instance = instance;
    this.view = view;
    displaySettings = this.instance.get("displaySettings");
    maxHeight = 500;
    if (displaySettings.maxHeight != null) {
      maxHeight = displaySettings.maxHeight;
    }
    this.tagBox = this.view.cj_selectors.tagBox;
    cj(document).on("mouseup", function(event, tagBox) {
      cj(document).off("mousemove");
      if (_this.tagBox.height() < 15) {
        _this.tagBox.height(0);
        _this.tagBox.addClass("dropdown");
        _this.view.settings.tall = false;
      }
      if (!_this.tagBox.hasClass("dropdown")) {
        bbUtils.localStorage("tagBoxHeight", {
          height: _this.tagBox.height()
        });
        _this.view.settings.tall = true;
      } else {
        bbUtils.localStorage("tagBoxHeight", {
          height: 0
        });
        _this.view.settings.tall = false;
      }
      return _this.view.setDescWidths();
    });
    return this.view.cj_tokenHolder.resize.on("mousedown", function(ev, tagBox) {
      if (_this.tagBox.hasClass("dropdown")) {
        _this.tagBox.height(0);
        _this.tagBox.show();
        _this.tagBox.removeClass("dropdown");
      }
      ev.preventDefault();
      return cj(document).on("mousemove", function(ev, tagBox) {
        var tagBoxHeight;
        _this.view.toggleDropdown();
        tagBoxHeight = ev.pageY - (cj(".JSTree").offset().top + cj(".JSTree-tokenHolder").height());
        if (tagBoxHeight < maxHeight) {
          return _this.tagBox.css("height", tagBoxHeight);
        }
      });
    });
  };

  return Resize;

})();

Autocomplete = (function() {
  var initHint;

  function Autocomplete(instance, view) {
    var cjac, debounced, params, searchmonger,
      _this = this;
    this.instance = instance;
    this.view = view;
    this.pageElements = this.instance.get('pageElements');
    this.dataSettings = this.instance.get('dataSettings');
    if (this.cjTagBox == null) {
      this.cjTagBox = cj("." + (this.pageElements.tagHolder.join(".")));
    }
    cj("#JSTree-data").data({
      "autocomplete": this.instance.autocomplete
    });
    params = {
      jqDataReference: "#JSTree-data",
      hintText: "Type in a partial or complete name of an tag or keyword.",
      theme: "JSTree"
    };
    if (!this.view.settings.wide) {
      params.hintText = "Search...";
    }
    cjac = cj("#JSTree-ac");
    this.hintText(cjac, params);
    searchmonger = cjac.tagACInput("init", params);
    cjac.on("click", (function(event) {
      if (cjac.val() === params.hintText) {
        cjac.val("");
        cjac.css("color", "#000");
        return _this.initHint = false;
      }
    }));
    debounced = bbUtils.debounce(this.execSearch, 500);
    cjac.on("keydown", (function(event) {
      return _this.filterKeydownEvents(debounced, event, searchmonger, cjac);
    }));
    cjac.on("keyup", (function(event) {
      var keyCode;
      keyCode = bbUtils.keyCode(event);
      if (keyCode.type === "delete" && cjac.val().length < 3) {
        _this.view.removeTabCounts();
        _this.view.shouldBeFiltered = false;
        _this.view.currentWrittenTerm = "";
        _this.view.cj_selectors.tagBox.find(".top-292.tagContainer").infiniscroll("unbind", cj(".JSTree"));
        _this.view.cj_selectors.tagBox.find(".top-292.tagContainer").remove("dt.loadingGif");
        if (_this.view.cj_selectors.tagBox.hasClass("dropdown")) {
          _this.view.toggleDropdown();
          _this.view.rebuildInitialTree();
        } else {
          _this.view.rebuildInitialTree();
        }
        if (_this.initHint) {
          _this.hintText(cjac, params);
          return _this.initHint = false;
        } else {
          return cjac.css("color", "#000");
        }
      }
    }));
  }

  initHint = true;

  Autocomplete.prototype.hintText = function(cjac, params) {
    cjac.val(params.hintText);
    return cjac.css("color", "#999");
  };

  Autocomplete.prototype.filterKeydownEvents = function(obj, event, searchmonger, cjac) {
    var keyCode, name;
    keyCode = bbUtils.keyCode(event);
    switch (keyCode.type) {
      case "directional":
        return true;
      case "letters":
      case "delete":
      case "math":
      case "punctuation":
      case "number":
        if (keyCode.type !== "delete") {
          name = keyCode.name;
        } else {
          name = "";
        }
        return obj(this, event, searchmonger, cjac);
      default:
        return false;
    }
  };

  Autocomplete.prototype.buildPositions = function(list, term, hits) {
    var openLeg, options,
      _this = this;
    if (this.positionPagesLeft > 1) {
      openLeg = new OpenLeg;
      options = {
        scrollBox: ".JSTree"
      };
      return this.cjTagBox.find(".top-292.tagContainer").infiniscroll(options, function() {
        var nextPage;
        _this.openLegQueryDone = false;
        nextPage = {
          term: _this.positionSearchTerm,
          page: _this.positionPage
        };
        _this.cjTagBox.find(".top-292.tagContainer").append(_this.addPositionLoader());
        return openLeg.query(nextPage, function(results) {
          var addButtonsTo, filteredList, k, poses, v;
          if (results.status != null) {
            console.log(results);
          }
          poses = _this.addPositionsToTags(results.results);
          filteredList = {
            292: poses
          };
          _this.getNextPositionRound(results);
          new Tree(poses, "292", false, cj(".JSTree .top-292"), nextPage);
          addButtonsTo = "";
          for (k in nextPage) {
            v = nextPage[k];
            addButtonsTo += "." + k + "-" + v;
          }
          new Buttons(_this.view, addButtonsTo);
          _this.openLegQueryDone = true;
          return _this.buildPositions();
        });
      });
    }
  };

  Autocomplete.prototype.addPositionLoader = function(nextPage) {
    if (nextPage == null) {
      nextPage = {};
    }
    return "<dt class='loadingGif' data-parentid='292'>      <div class='tag'>        <div class='ddControl'></div>        <div class='loadingText'>Loading...</div>      </div>    </dt>";
  };

  Autocomplete.prototype.execSearch = function(obj, event, searchmonger, cjac) {
    var term,
      _this = this;
    term = cjac.val();
    if (term.length >= 3) {
      obj.view.shouldBeFiltered = true;
      obj.doOpenLegQuery();
      return searchmonger.nExec(event, function(terms) {
        var filteredList, foundTags, hcounts, hits, k, tags, v;
        if ((terms != null) && !cj.isEmptyObject(terms)) {
          tags = obj.sortSearchedTags(terms.tags);
          hits = obj.separateHits(tags);
          hcounts = 0;
          foundTags = [];
          for (k in hits) {
            v = hits[k];
            hcounts += v;
            foundTags.push(parseFloat(k));
          }
          filteredList = obj.view.buildFilteredList(tags);
          obj.view.writeFilteredList(filteredList, terms.term.toLowerCase(), hits);
          obj.localQueryDone = true;
          if (obj.view.cj_selectors.tagBox.hasClass("dropdown")) {
            return obj.view.toggleDropdown(hits);
          }
        }
      });
    }
  };

  Autocomplete.prototype.doOpenLegQuery = function() {
    var openLeg, terms,
      _this = this;
    openLeg = new OpenLeg;
    terms = cj("#JSTree-ac").val();
    return openLeg.query({
      "term": terms
    }, function(results) {
      var filteredList, hitCount, poses;
      if (results.status != null) {
        console.log(results);
      }
      poses = _this.addPositionsToTags(results.results);
      filteredList = {
        292: poses
      };
      _this.getNextPositionRound(results);
      if (results.seeXmore === 0) {
        hitCount = results.results.length * 3;
      } else {
        hitCount = results.seeXmore;
      }
      _this.view.writeFilteredList(filteredList, terms.toLowerCase(), {
        292: hitCount
      });
      _this.buildPositions();
      _this.view.toggleDropdown({
        292: hitCount
      });
      return _this.openLegQueryDone = true;
    });
  };

  Autocomplete.prototype.separateHits = function(terms, results) {
    var hits, k, v;
    hits = {};
    for (k in terms) {
      v = terms[k];
      hits[k] = v.length;
    }
    if (hits[296] == null) {
      hits[296] = 0;
    }
    if (hits[291] == null) {
      hits[291] = 0;
    }
    return hits;
  };

  Autocomplete.prototype.positionIdNumber = 292000;

  Autocomplete.prototype.getNextPositionRound = function(results) {
    this.positionPage = results.page + 1;
    this.positionPagesLeft = results.pagesLeft;
    return this.positionSearchTerm = results.term;
  };

  Autocomplete.prototype.addPositionsToTags = function(positions) {
    var agipos, checkName, format, forpos, k, neupos, o, positionList, v, _ref,
      _this = this;
    format = [];
    positionList = this.instance.positionList;
    checkName = function(name, v) {
      if (_utils.removePositionTextFromBill(name) === v.name && _utils.checkPositionFromBill(name) === v.pos) {
        return true;
      }
      return false;
    };
    for (k in positions) {
      o = positions[k];
      forpos = {
        name: o.forname,
        id: "" + (this.positionIdNumber + 1),
        position: "for"
      };
      agipos = {
        name: o.againstname,
        id: "" + (this.positionIdNumber + 2),
        position: "against"
      };
      neupos = {
        name: o.noname,
        id: "" + (this.positionIdNumber + 3),
        position: "neutral"
      };
      _ref = this.instance.positionList;
      for (k in _ref) {
        v = _ref[k];
        if (_utils.removePositionTextFromBill(forpos.name) === v.name) {
          if (_utils.checkPositionFromBill(forpos.name) === v.pos) {
            forpos.id = v.id;
          }
        }
        if (_utils.removePositionTextFromBill(agipos.name) === v.name) {
          if (_utils.checkPositionFromBill(agipos.name) === v.pos) {
            agipos.id = v.id;
          }
        }
        if (_utils.removePositionTextFromBill(neupos.name) === v.name) {
          if (_utils.checkPositionFromBill(neupos.name) === v.pos) {
            neupos.id = v.id;
          }
        }
      }
      forpos.billNo = agipos.billNo = neupos.billNo = o.billNo;
      forpos.type = agipos.type = neupos.type = "292";
      forpos.description = agipos.description = neupos.description = o.description;
      forpos.children = agipos.children = neupos.children = false;
      forpos.created_date = agipos.created_date = neupos.created_date = "";
      forpos.created_id = agipos.created_id = neupos.created_id = "";
      forpos.created_name = agipos.created_name = neupos.created_name = "";
      forpos.parent = agipos.parent = neupos.parent = "292";
      forpos.level = agipos.level = neupos.level = 1;
      forpos.url = agipos.url = neupos.url = o.url;
      format.push(forpos);
      format.push(agipos);
      format.push(neupos);
      this.positionIdNumber = this.positionIdNumber + 10;
    }
    return this.positionListing = format;
  };

  Autocomplete.prototype.sortSearchedTags = function(tags) {
    var list;
    list = {};
    cj.each(tags, function(i, el) {
      var obj;
      if (list[el.type] == null) {
        list[el.type] = [];
      }
      obj = {
        id: el.id,
        name: el.name
      };
      return list[el.type].push(obj);
    });
    return list;
  };

  return Autocomplete;

})();

_openTags = {};

_treeVisibility = {
  currentTree: "",
  defaultTree: "",
  previousTree: ""
};

Tree = (function() {
  Tree.prototype.domList = {};

  Tree.prototype.nodeList = {};

  Tree.prototype.tabName = "";

  function Tree(tagList, tagId, filter, location, listClasses) {
    this.tagList = tagList;
    this.tagId = tagId;
    this.filter = filter != null ? filter : false;
    this.location = location;
    this.listClasses = listClasses;
    this.buildTree();
    return this;
  }

  Tree.prototype.buildTree = function() {
    var dataNames, filter, k, v, _ref;
    if (this.filter) {
      filter = "filtered";
    } else {
      filter = "";
    }
    if (this.location != null) {
      if (this.location === "init") {
        this.append = "292";
      } else {
        this.append = true;
      }
      this.domList = cj();
      if (this.listClasses != null) {
        dataNames = "";
        _ref = this.listClasses;
        for (k in _ref) {
          v = _ref[k];
          dataNames += " " + k + "-" + v + " ";
        }
        this.domList = this.domList.add("<div class='" + dataNames + "'></div>");
      } else {
        this.domList = this.domList.add("<div></div>");
      }
    } else {
      this.domList = cj();
      this.domList = this.domList.add("<div class='top-" + this.tagId + " " + filter + " tagContainer' data-treeid='" + this.tagId + "'></div>");
    }
    return this.iterate(this.tagList);
  };

  Tree.prototype.iterate = function(ary) {
    var buttons, cjTagList, cjToAppendTo, kNode, node, _i, _len,
      _this = this;
    cjTagList = cj(this.domList);
    for (_i = 0, _len = ary.length; _i < _len; _i++) {
      node = ary[_i];
      this.nodeList[node.id] = kNode = new Node(node);
      if (node.parent === this.tagId) {
        cjTagList.append(kNode.html);
      } else {
        cjToAppendTo = cjTagList.find("dl#tagDropdown_" + kNode.parent);
        if (cjToAppendTo.length === 0) {
          cjTagList.append(kNode.html);
        } else {
          cjToAppendTo.append(kNode.html);
        }
      }
    }
    if (!this.append) {
      cjTagList.appendTo(".JSTree");
    } else {
      if (this.append === "292") {
        cj("<div class='top-292 tagContainer'></div>").appendTo(".JSTree");
      } else {
        this.location.find(".loadingGif").replaceWith(cjTagList);
      }
    }
    this.html = cjTagList;
    _treeUtils.makeDropdown(cj(".JSTree .top-" + this.tagId));
    if (this.filter) {
      buttons = cj(".JSTree .top-" + this.tagId + " .treeButton").parent().parent();
      return cj.each(buttons, function(i, button) {
        return _treeUtils.dropdownItem(cj(button), true);
      });
    } else {
      return _treeUtils.readDropdownsFromLocal(this.tagId, this.tagList);
    }
  };

  Tree.prototype.appendNode = function(node, parent, html, noAdd) {
    var cjParentDL, cjParentDT, i, obj, parentDL, parentDT, topLevel, _i, _j, _len, _len1, _ref, _ref1;
    if (noAdd == null) {
      noAdd = false;
    }
    topLevel = false;
    if (parseInt(parent) === 291 || parseInt(parent) === 292 || parseInt(parent) === 296) {
      topLevel = true;
      if (noAdd) {
        parentDT = "#tagLabel_" + node.id;
        parentDL = "#tagDropdown_" + node.id;
        _ref = this.tagList;
        for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
          obj = _ref[i];
          if (obj.id === node.id) {
            this.tagList.splice(i, 1);
            this.tagList.splice(i, 0, node);
            break;
          }
        }
      } else {
        parentDT = "";
        parentDL = ".JSTree .top-" + node.type;
        cjParentDT = cj(parentDT);
        this.tagList.push(node);
      }
    } else {
      parentDT = ".JSTree #tagLabel_" + parent;
      parentDL = ".JSTree #tagDropdown_" + parent;
      cjParentDT = cj(parentDT);
      if (cjParentDT.length === 0) {
        return false;
      }
      this.tagList.push(node);
    }
    if (noAdd) {
      cj(this.domList).find(parentDT).replaceWith(html);
      cj(this.html).find(parentDT).replaceWith(html);
    } else {
      cj(this.domList).find(parentDT).prepend(html);
      cj(this.html).find(parentDT).prepend(html);
    }
    if (noAdd) {
      return true;
    }
    cjParentDL = cj(parentDL);
    cjParentDL.show().prepend(html);
    if (topLevel) {
      return true;
    }
    _ref1 = this.tagList;
    for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
      obj = _ref1[i];
      if (parent === obj.id) {
        obj.children = true;
      }
    }
    cjParentDT.addClass("open");
    cjParentDT.find(".ddControl").addClass("treeButton");
    return true;
  };

  Tree.prototype.removeNode = function(nodeId, noDel) {
    var cjDL, cjDT, cjParentDT, i, obj, parentId, realTree, removeFrom, _i, _j, _len, _len1, _ref, _results;
    realTree = "#JSTree-container .JSTree";
    if (this.hasChildren(cj(realTree), nodeId)) {
      return false;
    }
    _ref = this.tagList;
    for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
      obj = _ref[i];
      if (parseInt(obj.id) === nodeId) {
        this.tagList.splice(i, 1);
        break;
      }
    }
    removeFrom = [this.domList, this.html, realTree];
    _results = [];
    for (_j = 0, _len1 = removeFrom.length; _j < _len1; _j++) {
      i = removeFrom[_j];
      cjDT = cj(i).find("#tagLabel_" + nodeId);
      cjDL = cj(i).find("#tagDropdown_" + nodeId);
      parentId = cjDT.data('parentid');
      cjDT.remove();
      cjDL.remove();
      if (!this.hasChildren(i, parentId)) {
        cjParentDT = cj(i).find("#tagLabel_" + parentId);
        cjParentDT.removeClass("open");
        _results.push(cjParentDT.find(".ddControl").removeClass("treeButton"));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  Tree.prototype.hasChildren = function(tree, nodeId) {
    var cjDL;
    cjDL = cj(tree).find("#tagDropdown_" + nodeId);
    if (cjDL.children().length > 0) {
      return true;
    }
    return false;
  };

  return Tree;

})();

_treeUtils = {
  selectByParent: function(list, parent) {
    var b, childList, _i, _len;
    childList = [];
    for (_i = 0, _len = list.length; _i < _len; _i++) {
      b = list[_i];
      if (b.parent === parent) {
        childList.push(b);
      }
    }
    return childList;
  },
  selectByTree: function(list, tree) {
    var b, treeList, _i, _len;
    treeList = [];
    for (_i = 0, _len = list.length; _i < _len; _i++) {
      b = list[_i];
      if (b.type === tree) {
        treeList.push(b);
      }
    }
    return treeList;
  },
  makeDropdown: function(cjTree) {
    cjTree.find(".treeButton").off("click");
    return cjTree.find(".treeButton").on("click", function() {
      return _treeUtils.dropdownItem(cj(this).parent().parent());
    });
  },
  dropdownItem: function(tagLabel, filter) {
    var tagid;
    if (filter == null) {
      filter = false;
    }
    tagid = tagLabel.data('tagid');
    if (tagLabel.length > 0) {
      if (tagLabel.is(".open")) {
        _openTags[tagid] = false;
      } else {
        _openTags[tagid] = true;
      }
    }
    tagLabel.siblings("#tagDropdown_" + tagid).slideToggle("200");
    tagLabel.toggleClass("open");
    if (!filter) {
      return bbUtils.localStorage("tagViewSettings", _openTags);
    }
  },
  readDropdownsFromLocal: function(cjTree) {
    var bool, tag, _ref;
    if (parseInt(cjTree) === 291) {
      if (bbUtils.localStorage("tagViewSettings")) {
        _openTags = bbUtils.localStorage("tagViewSettings");
        _ref = bbUtils.localStorage("tagViewSettings");
        for (tag in _ref) {
          bool = _ref[tag];
          if (bool) {
            this.dropdownItem(cj("#tagLabel_" + tag));
          } else {
            delete _openTags[tag];
          }
        }
      } else {

      }
      return _openTags;
    }
  }
};

_descWidths = {
  normal: 75,
  long: 150
};

Node = (function() {
  function Node(node) {
    this.setValues(node);
    return this;
  }

  Node.prototype.setValues = function(node) {
    var levelModifier;
    this.data = node;
    this.parent = node.parent;
    this.hasDesc = "";
    this.description = node.description;
    this.descLength(node.description);
    this.id = node.id;
    this.children = node.children;
    this.name = node.name;
    this.nameLength = "";
    this.billNo = node.billNo;
    this.isreserved = node.is_reserved;
    if (node.type === 292) {
      if (this.billNo == null) {
        this.billNo = node.name;
      }
      this.name = node.posName;
    }
    if (this.billNo == null) {
      this.billNo = "";
    }
    this.position = node.position;
    if (this.position == null) {
      this.position = node.pos;
    }
    if (this.position == null) {
      this.position = "";
    }
    if (this.name.length >= _descWidths.normal) {
      levelModifier = 0;
      if (node.level > 2) {
        levelModifier = node.level * 5;
      }
      this.name = _utils.textWrap(this.name, _descWidths.normal - levelModifier);
      this.name = this.name.toRet.join('<br />');
      this.nameLength = "longName";
    }
    this.name = cj.trim(this.name);
    this.html = this.getHtml(node);
    return true;
  };

  Node.prototype.descLength = function(description) {
    var desc, i, tempDesc, text, _i, _len, _ref;
    this.description = description;
    if (this.description === null || this.description === "null") {
      this.description = "";
      return true;
    }
    if (this.description != null) {
      if (this.description.length > 0) {
        desc = _utils.textWrap(this.description, _descWidths.normal);
        if (desc.segs === 1) {
          this.hasDesc = "description shortdescription";
        }
        if (desc.segs === 2) {
          this.hasDesc = "description";
        }
        if (desc.segs >= 3) {
          this.hasDesc = "longdescription";
        }
        if (desc.segs > 3) {
          tempDesc = "";
          _ref = desc.toRet;
          for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
            text = _ref[i];
            tempDesc += "" + text + "<br />";
            if (i >= 2) {
              break;
            }
          }
          return this.description = tempDesc;
        } else {
          if (desc.segs > 1) {
            return this.description = desc.toRet.join("<br />");
          } else {
            return this.description = desc.toRet[0];
          }
        }
      }
    }
  };

  Node.prototype.getHtml = function(node) {
    var html, treeButton;
    if (node.children) {
      treeButton = "treeButton";
    } else {
      treeButton = "";
    }
    if (parseFloat(node.is_reserved) !== 0) {
      this.reserved = true;
    } else {
      this.reserved = false;
    }
    html = "<dt class='lv-" + node.level + " " + this.hasDesc + " tag-" + node.id + " " + this.nameLength + "' id='tagLabel_" + node.id + "'             data-tagid='" + node.id + "' data-tree='" + node.type + "' data-name='" + node.name + "'              data-parentid='" + node.parent + "' data-billno='" + this.billNo + "'             data-position='" + this.position + "' data-level='" + node.level + "'             data-isreserved='" + this.isreserved + "'            >";
    html += "              <div class='tag'>                <div class='ddControl " + treeButton + "'></div>                <div class='name'>" + this.name + "</div>            ";
    if (this.hasDesc.length > 0) {
      html += "                <div class='description'>" + this.description + "</div>            ";
    }
    html += "              </div>              </dt>            ";
    html += "              <dl class='lv-" + node.level + "' id='tagDropdown_" + node.id + "' data-tagid='" + node.id + "' data-name='" + node.name + "'></dl>            ";
    return html;
  };

  return Node;

})();

Token = (function() {
  function Token(cjLocation) {
    if (cjLocation.children().length === 2) {

    } else {

    }
  }

  Token.prototype.dropdown = function(cjLocation) {};

  Token.prototype.create = function(cjLocation, name, type, id, cb) {
    var html,
      _this = this;
    html = "<div class='token token-" + id + "' data-name='" + name + "' data-type='" + type + "'>                " + name + "             </div>           ";
    cjLocation.append(html);
    cjLocation.find(".token-" + id).on("click", function() {
      cb.call(_this);
      return cjLocation.find(".token-" + id).remove();
    });
    return this;
  };

  return Token;

})();
